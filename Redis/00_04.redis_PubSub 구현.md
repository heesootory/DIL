# redis Pub Sub êµ¬í˜„





## ğŸŒˆ êµ¬í˜„ ì˜ˆì œ ì½”ë“œ

> redis pub/sub ê¸°ëŠ¥ì„ êµ¬í˜„í•´ ë©”ì„¸ì§€ ì „ë‹¬ êµ¬í˜„í•´ë³´ê¸°.

> publisherì™€ Subsrciberë¥¼ serviceë¡œ êµ¬í˜„í•˜ë¯€ë¡œ, í•˜ë‚˜ì˜ serverì—ì„œ êµ¬í˜„í•  ìˆ˜ ìˆì§€ë§Œ, ê²°ê³¼ë¥¼ ì¢€ë” íš¨ê³¼ì ìœ¼ë¡œ ë³´ê¸° ìœ„í•´ì„œ ë”°ë¡œ êµ¬í˜„í•¨.

> ì±„íŒ…ì„ êµ¬í˜„í• ì‹œ í•¨ê»˜ í•œ ì„œë²„ì—ì„œ êµ¬í˜„í•¨.

<br>

### ğŸ³ ë²„ì ¼ & í™˜ê²½ì„¤ì •

<br>

* java - 11
* gradle
* springboot - 2.7.9
* dependencies
    - web, dev, lombok, redis Driver


<br>
<br>
<br>

## ğŸŒˆ Publish Server

<br>

> ë©”ì„¸ì§€ë¥¼ ì†¡ì‹ í•  ì„œë²„.

<br>
<br>

### ğŸ³ application.yml

<br>

```yml
spring:
  redis:
    host: localhost
    port: 6379
```

<br>
<br>

### ğŸ³ config

<br>

```java
import com.example.redis_pub_sub_test.entity.ChatMessage;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.listener.ChannelTopic;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@Configuration
public class RedisConfig {

    // redis ì—°ê²° êµ¬í˜„ì²´ ì‚½ì….
    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory();
    }

    //redisTemplate ì„¤ì •
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer<>(ChatMessage.class));
        return redisTemplate;
    }

    //pub/sub í† í”½ ì„¤ì •
    @Bean
    ChannelTopic topic() {
        return new ChannelTopic("ssafy");
    }
```


<br>
<br>

### ğŸ³ controller

<br>

```java
import com.example.redis_pub_sub_test.entity.ChatMessage;
import com.example.redis_pub_sub_test.service.RedisPubService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequiredArgsConstructor
public class RedisController {

    private final RedisPubService redisPubService;

    @PostMapping("api/chat")
    public String pubSub(@RequestBody ChatMessage chatMessage) {
        //ë©”ì‹œì§€ ë³´ë‚´ê¸°
        redisPubService.sendMessage(chatMessage);
        return "success";
    }

}

```

<br>
<br>

### ğŸ³ entity

<br>

```java
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
@AllArgsConstructor
public class ChatMessage {

    private String sender;
    private String context;

}

```

<br>
<br>

### ğŸ³ service

<br>

```java
import com.example.redis_pub_sub_test.entity.ChatMessage;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
@Slf4j
public class RedisPubService {

    private final RedisTemplate<String, Object> redisTemplate;

    public void sendMessage(ChatMessage chatMessage) {
        // í•´ë‹¹ ì±„ë„(topic)ìœ¼ë¡œ ë©”ì„¸ì§€ë¥¼ ë³´ë‚´ëŠ” ë©”ì„œë“œ. (redisTemplateë¥¼ ì‚¬ìš©í•´ ì§ë ¬í™”í•˜ì—¬ ì „ì†¡)
        redisTemplate.convertAndSend("ssafy", chatMessage);
    }

}

```

<br>
<br>
<br>


## ğŸŒˆ Publish Server

<br>

> ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ í•  ì„œë²„. 

> ì„œë²„ë¥¼ êµ¬í˜„í•´ì„œ ìˆ˜ì‹ í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ìœ¼ë¡œ í•˜ë©´ë˜ì§€ë§Œ, ì‚¬ì‹¤ í•´ë‹¹ topic(ì±„ë„)ë¥¼ êµ¬ë…ì¤‘ì¸ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ëŠ” ë©”ì„¸ì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆë‹¤.


<br>
<br>

### ğŸ³ application.yml

<br>

```yml
server:
  port: 8081    # publisherì™€ ë‹¤ë¥¸ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´

spring:
  redis:
    host: localhost
    port: 6379
```


<br>
<br>

### ğŸ³ config

<br>

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.listener.ChannelTopic;
import org.springframework.data.redis.listener.RedisMessageListenerContainer;
import org.springframework.data.redis.listener.adapter.MessageListenerAdapter;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

@Configuration
public class RedisConfig {

    // ë ˆë””ìŠ¤ ì—°ê²°ì„ í•  ìˆ˜ ìˆëŠ” êµ¬í˜„ì²´ ì¤‘ í•˜ë‚˜ì¸ LettuceConnectionFactoryë¥¼ ìƒì„±. -> ë ˆíˆ¬ìŠ¤ë¥¼ ì‚¬ìš©í•´ ë ˆë””ìŠ¤ ì—°ë™ì„ ì‹¤í–‰.
    // -> "ë ˆíˆ¬ìŠ¤ êµ¬í˜„ì²´"ë¥¼ ê°–ë‹¤ ë¼ì›Œì„œ ì“°ì!!
    // RedisConnectionFactoryëŠ” ë ˆë””ìŠ¤ ì—°ê²°ì„ í•  ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ ë…¼ ì¸í„°í˜ì´ìŠ¤.
    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        return new LettuceConnectionFactory();
    }

    //redisTemplate ì„¤ì • - ì§ë ¬í™”/ ì—­ì§ë ¬í™” ì„¤ì •,
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(redisConnectionFactory());
        redisTemplate.setKeySerializer(new StringRedisSerializer());
        redisTemplate.setValueSerializer(new Jackson2JsonRedisSerializer<>(ChatMessage.class));
        return redisTemplate;
    }

    //ë¦¬ìŠ¤ë„ˆì–´ëŒ‘í„° ì„¤ì •
    // * MessageListenerAdapterëŠ” RedisMessageListenerContainerì—ì„œ íŠ¹ì • í† í”½ì— ë©”ì‹œì§€ê°€ ì˜¨ ê²½ìš° ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” í´ë˜ìŠ¤ì„.
    // * MessageListener ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ êµ¬í˜„ì²´.
    // * ê²°êµ­ MessageListenerì¸í„°í˜ì´ìŠ¤ì— ìŠ¤í”„ë§ ë‚´ì˜ ì–´ë–¤ service ê°ì²´ë¥¼ êµ¬í˜„ì²´ë¡œ ê½ƒì•„ ë„£ì„ê±´ì§€ ì •ì˜í•´ì£¼ëŠ” í•¨ìˆ˜.
    @Bean
    MessageListenerAdapter messageListenerAdapter() {
        return new MessageListenerAdapter(new RedisSubService());
    }

    //ì»¨í…Œì´ë„ˆ ì„¤ì •
    // * MessageListenerë¥¼ ê´€ë¦¬í•˜ëŠ” Containerë¡œ Redis ì±„ë„ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ê³ , í•´ë‹¹ ì±„ë„ì— ë“±ë¡ëœ MessageListenerì— ì°¾ê³ ,
    // í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì£¼ì…í•˜ëŠ” ì—­í• ì„ í•¨
    // * ê²°êµ­ ì´ê²ƒë„ ìŠ¤í”„ë§ì•ˆì—ì„œ LettuceConnectionFactoryë¥¼ ì´ìš©í•´, ë ˆë””ìŠ¤ì™€ ì—°ë™ë˜ê³ , ë” êµ¬ì²´ì ìœ¼ë¡œ ìŠ¤í”„ë§ë‚´ì˜ "êµ¬ë…service"(ë¦¬ìŠ¤ë„ˆ)
    // ì™€ ë ˆë””ìŠ¤ ë‚´ì˜ ì±„ë„ì„ ì—°ê²°í•¨.
    @Bean
    RedisMessageListenerContainer redisContainer() {
        // "ë ˆë””ìŠ¤ ë©”ì„¸ì§€ ë¦¬ìŠ¤í„°" ì»¨í…Œì´ë„ˆ ìƒì„±
        RedisMessageListenerContainer container = new RedisMessageListenerContainer();
        // RedisConnectionFactoryì˜ êµ¬í˜„ì²´ì¸ LettuceConnectionFactoryë¡œ ì—°ê²°. -> ìŠ¤í”„ë§ê³¼ ë ˆë””ìŠ¤ë¥¼ ì—°ê²° (ëŒ€ëµì  ì—°ê²°)
        container.setConnectionFactory(redisConnectionFactory());
        // MessageListener êµ¬í˜„ì²´ì¸ messageListenerAdapterì™€ ì±„ë„(topic)ì„ ì—°ê²°í•´ì¤Œ. -> êµ¬ë…í•  ì„œë¹„ìŠ¤ì™€ ë ˆë””ìŠ¤ë‚´ì˜ ì±„ë„ì„ ì—°ê²°. (êµ¬ì²´ì  ì—°ê²°)
        container.addMessageListener(messageListenerAdapter(), topic());
        return container;
    }

    //pub/sub í† í”½ ì„¤ì •
    @Bean
    ChannelTopic topic() {
        return new ChannelTopic("ssafy");
    }

}

```


<br>
<br>

### ğŸ³ entity

<br>

```java
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;

@Getter
@NoArgsConstructor
@AllArgsConstructor
public class ChatMessage {

    private String sender;
    private String context;

}

```


<br>
<br>

### ğŸ³ service

<br>

```java
package com.example.redis_sub_test;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.connection.Message;
import org.springframework.data.redis.connection.MessageListener;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class RedisSubService implements MessageListener{

    public static List<String> messageList = new ArrayList<>();
    private final ObjectMapper mapper = new ObjectMapper();

    // MessageListener ì¸í„°í˜ì´ìŠ¤ì˜ onMessage ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì„œ ë©”ì„¸ì§€ ìˆ˜ì‹ .
    // Message ê°ì²´ -> ì±„ë„ëª…(topic)ê³¼ payloadê°€ í•¨ê»˜ ë“¤ì–´ìˆëŠ” ê°ì²´. (ë‘˜ë‹¤ byte ë°°ì—´ë¡œ ë§Œë“¤ì–´ì§.)
    @Override
    public void onMessage(Message message, byte[] pattern){
        try {
            // byteí™” ë˜ì–´ìˆëŠ” messageê°ì²´ë¥¼ Json ê°ì²´ë¡œ ë³€í™˜.
            ChatMessage chatMessage = mapper.readValue(message.getBody(), ChatMessage.class);
            
            // message ë‚´ìš©ì´ byte ì½”ë“œë¡œ ê·¸ëŒ€ë¡œ ì¶œë ¥
            System.out.println(message.getBody() + "/" + message.getBody().getClass());

            // ë‹¨ìˆœ ì¶œë ¥ í™•ì¸
            System.out.println(messageList.toString());
            System.out.println("ë°›ì€ ë©”ì‹œì§€ = " + message.toString());
            System.out.println("chatMessage.getSender() = " + chatMessage.getSender());
            System.out.println("chatMessage.getContext() = " + chatMessage.getContext());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

}

```



<br>
<br>
<br>

## ğŸŒˆ ë©”ì„¸ì§€ êµ¬ë… í™•ì¸

<br>

> êµ¬ë…ì„ spring server, cli, redis insight 3ê°œë¡œ ëª¨ë‘ ê°™ì€ redis ì±„ë„ì„ ì—°ê²°í•œ ê²½ìš° ëª¨ë‘ ê°™ì€ ë©”ì„¸ì§€ë¥¼ ë™ì‹œì— í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

<br>

* publisher controllerë¥¼ ì´ìš©í•´ ë©”ì„¸ì§€ ì†¡ì‹ .

<img
    src = "../Image/redis/pubsub/redis0.png"
    width = 700px
    height = 400px
/>

* subscriber(1) - êµ¬ë… ì„œë²„

<img
    src = "../Image/redis/pubsub/redis1.png"
    width = 700px
    height = 400px
/>


* subscriber(2) - clië¥¼ ì´ìš©í•´ êµ¬ë…

<img
    src = "../Image/redis/pubsub/redis2.png"
    width = 700px
    height = 150px
/>


* subscriber(3) - redis insight ë¡œ êµ¬ë….

<img
    src = "../Image/redis/pubsub/redis3.png"
    width = 800px
    height = 400px
/>


