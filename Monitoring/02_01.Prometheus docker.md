# í”„ë¡œë©”í…Œìš°ìŠ¤ docker 






## springboot ì˜ì¡´ì„±

> í”„ë¡œë©”í…Œìš°ìŠ¤ì— metricsë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ì„  ê° ì„œë¹„ìŠ¤ springbootì— ë‹¤ìŒì˜ ì˜ì¡´ì„±ë“¤ì„ ì¶”ê°€í•œë‹¤.

```yml
implementation 'org.springframework.boot:spring-boot-starter-actuator'
implementation 'io.micrometer:micrometer-registry-prometheus'
```




## docker run


* ì‹¤ì œ í”„ë¡œë©”í…Œìš°ìŠ¤ë¥¼ ë‹¤ìš´ë°›ì•˜ì„ë•Œ, ìƒê¸°ëŠ” prometheus.ymlì´ í•„ìš”í•˜ë‹¤.
    - ê¸°ì¡´ì˜ prometheus.ymlì´ docker containerì— ì¡´ì¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, ìš°ë¦¬ê°€ ë³¼ë¥¨ë§ˆìš´íŠ¸ë¡œ ë„£ì–´ì£¼ì§€ ì•Šìœ¼ë©´ containerê°€ ëŒì§€ ì•ŠìŒ.

* docker image : prom/prometheus

```zsh
docker run -d -p 9090:9090 --name --network [network ëª…] pro -v C:\Users\SSAFY\Desktop\prom\prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
```


## prometheus.yml ì„¤ì •

```sh
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]
  
  - job_name: "member-service"
    metrics_path: '/member/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['host.docker.internal:8000']

  # - job_name: "item-service"
  #   metrics_path: '/item/actuator/prometheus'
  #   scrape_interval: 1s
  #   static_configs:
  #     - targets: ['apigateway-service:8000']
```

* job_name : ì„œë¹„ìŠ¤ ì´ë¦„(ì•„ë¬´ê±°ë‚˜ ìƒê´€ì—†ìŒ)
* metrics_path : í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ prometheus ì •ë³´ ê²½ë¡œë¥¼ ì„¤ì •.
* scrape_interval : ë©”íŠ¸ë¦­ ìˆ˜ì§‘ì„ ëª‡ì´ˆ ì£¼ê¸°ë¡œ í• ì§€ ì„¤ì •.
* static_configs : ip ì£¼ì†Œ ì„¤ì •
    - targets : í•´ë‹¹ ì„œë¹„ìŠ¤ ì „ì²´ì˜ ipì£¼ì†Œ.

> ğŸˆ dockerë¡œ ì‚¬ìš©ì‹œ ì£¼ì˜í• ì !

> í”„ë¡œë©”í…Œìš°ìŠ¤ì„œë²„ë¥¼ dockerë¡œ ì‚¬ìš©í• ì‹œ, targetsì— ipì£¼ì†Œë¥¼ ì ì„ë•Œ localhost:[portë²ˆí˜¸]ë¡œ ì‘ì„±í•˜ë©´ í•´ë‹¹ containerë¥¼ localhostë¡œ ìƒê°í•˜ê¸° ë•Œë¬¸ì—, containerì˜ ì£¼ì¸ì˜ ip ì£¼ì†Œì¸ "host.docker.internal"ë¥¼ ì ì–´ì¤Œìœ¼ë¡œì¨ ì—°ê²°ì´ ê°€ëŠ¥í•˜ë‹¤.

> í˜¹ì€ ì „ì²´ MSAê°€ docker networkë¡œ ë¬¶ì—¬ìˆëŠ”ê²½ìš°ì—ëŠ”, docker networkì˜ ì§„ì…ì ì¸ apigateway-serviceì˜ container nameë¥¼ localhostëŒ€ì‹  ì‚¬ìš©í•´ë„ ê°€ëŠ¥í•˜ë‹¤.


### ë¡œì»¬ test

```
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["localhost:9090"]  # í”„ë¡œë©”í…Œìš°ìŠ¤ ìì²´ ì„¤ì •.
  
  - job_name: "member-service"
    metrics_path: '/member/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      # - targets: ['apigateway-service:8000']
      - targets: ['host.docker.internal:8000']
  # - job_name: "item-service"
  #   metrics_path: '/item/actuator/prometheus'
  #   scrape_interval: 10s
  #   static_configs:
  #     - targets: ['apigateway-service:8000']
  # - job_name: "chat-service"
  #   metrics_path: '/chat/actuator/prometheus'
  #   scrape_interval: 10s
  #   static_configs:
  #     - targets: ['apigateway-service:8000']
  # - job_name: "flight-service"
  #   metrics_path: '/flight/actuator/prometheus'
  #   scrape_interval: 10s
  #   static_configs:
  #     - targets: ['apigateway-service:8000']
  - job_name: "apigateway-service"
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['host.docker.internal:8000']
```



### íŠ¹í™” í”„ë¡œì íŠ¸ - pickpack Projectì˜ êµ¬ì„±

* ec2 ë‚´ì˜ docker network ì—ì„œ êµ¬ì„±

```yml
# my global config
global:
  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
  # scrape_timeout is set to the global default (10s).

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: "prometheus"

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ["prometheus:9090"]  # í”„ë¡œë©”í…Œìš°ìŠ¤ ìì²´ ì„¤ì •.
  
  - job_name: "member-service"
    metrics_path: '/member/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['apigateway-service:8000']
      # - targets: ['host.docker.internal:8000']
  - job_name: "item-service"
    metrics_path: '/item/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['apigateway-service:8000']
  - job_name: "chat-service"
    metrics_path: '/chat/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['apigateway-service:8000']
  - job_name: "flight-service"
    metrics_path: '/flight/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['apigateway-service:8000']
  - job_name: "apigateway-service"
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
    static_configs:
      - targets: ['apigateway-service:8000']
```














