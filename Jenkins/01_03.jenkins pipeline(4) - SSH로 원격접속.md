# SSHë¡œ ì›ê²©ì ‘ì† -> deploy EC2 + docker Image pull


<br>
<br>


## ğŸŒˆ jenkins serverì— ê¸°ë³¸ ì„¸íŒ…

<br>

### ğŸ³ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜.

> SSH Agent Plugin ì„¤ì¹˜.

<br>

### ğŸ³ deploy serverì— jenkins serverì˜ ê³µê°œí‚¤ ì„¤ì •.

> jenkins serverì—ì„œ deploy serverì— ì›ê²©ì ‘ì†ì„ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ì ‘ì†ê°€ëŠ¥í•˜ê²Œ í•˜ê¸°ìœ„í•´ ì„¤ì •.

* Jenkins Serverì—ì„œ public key í™•ì¸
    ```zsh
    $ cat /home/ubuntu/.ssh/id_rsa.pub
    ```

* deploy serverì— id_rsa.pub(ê³µê°œí‚¤) ì„¤ì •.
    ```zsh
    $ vi /home/ubuntu/.ssh/authorized_keys
    // ì•ˆì— í•œì¤„ ë„ê³ , ìœ„ì˜ ê³µê°œí‚¤(id_rsa.pub) ë¶™ì—¬ë„£ê¸°!
    ```

### ğŸ³ jenkinsì— jenkins serverì˜ ê°œì¸í‚¤ ì„¤ì •.

* Jenkins Serverì˜ private key í™•ì¸
    ```zsh
    $ cat /home/ubuntu/.ssh/id_rsa
    ```

* jenkins credentials ë“±ë¡
    - kind : SSH Username with private key
    - ID : pipelineì—ì„œ ì‚¬ìš©ë  alias. (ì•„ë¬´ê±°ë‚˜ ê°€ëŠ¥)
    - Username : root(default)
    - private key 
        - enter directly : jenkins serverì˜ id_rsa ë“±ë¡.


## ğŸŒˆ pipeline script

> ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” EC2 ì´ˆê¸°ìƒíƒœì—” ì–´ë–¤ ì»¨í…Œì´ë„ˆë„ êµ¬ë™ ì¤‘ì´ì§€ ì•Šê¸° ë•Œë¬¸ì—, ë‘ë²ˆì§¸ ëª…ë ¹ì—ì„œ ì—ëŸ¬ë¥¼ ë°œìƒí•œë‹¤. ë”°ë¼ì„œ, í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ë¡œëŠ” ì§ì ‘ ec2ì— ì ‘ì†í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ í•˜ë‚˜ êµ¬ë™ì‹œì¼œì£¼ê³ , jenkins CI/CDë¥¼ ì‹¤í–‰í•˜ë©´ ì •ìƒì‘ë™ í•˜ê²Œëœë‹¤.

> ì¶”í›„, whenìœ¼ë¡œ ë¶„ê¸°ë¬¸ ì²˜ë¦¬ë¥¼ (groovy ë¬¸ë²• ê³µë¶€!!) í•˜ì—¬ ë§¤ë„ëŸ½ê²Œ ì§„í–‰ì‹œí‚¤ì.

<br>
<br>

* ubuntu@43.200.252.25 ì ‘ì†, [imagename]ì— í•´ë‹¹í•˜ëŠ” Image pull
    - "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker pull ${imagename}'" 

* [containerName]ì— í•´ë‹¹í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì¢…ë£Œ.
    - "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker ps -q --filter name=\${containerName} | grep -q . && docker rm -f \$(docker ps -aq --filter name=${containerName})'"

* [imagename]ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ [containerName]ëª…ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰.
    - "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker run -d --name ${containerName} -p 8080:8080 ${imagename}'"

* íƒœê·¸ê°€ "none"ì¸ ì´ë¯¸ì§€ ëª¨ë‘ ì‚­ì œ.
    - "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker rmi -f \$(docker images --filter ${noneFile} -q)'"


```groovy
pipeline {
    agent any
    
    environment {
        imagename = "heesootory/jenkins_pipe"
        registryCredential = 'docker_hub'
        dockerImage = ''
        containerName = 'spring'
        noneFile = '"dangling=true"'
    }

    stages {
        stage('Git Clone ğŸ¦Š') {
            steps {
                git url: 'https://github.com/heesootory/jenkins_pipe_test.git',
                    branch: 'main',
                    credentialsId: 'github_token'
            }
        }
        
        stage('Bulid Gradle ğŸ€') {
            steps {
                echo 'Bulid Gradle'
                dir('.'){
                    sh './gradlew clean build'
                }
            }
        }
        
        stage('Bulid Docker ğŸ³') {
            steps {
                echo 'Bulid Docker'
                script {
                    dockerImage = docker.build imagename
                }
            }
        }

        stage('Push Docker ğŸš€') {
            steps {
                echo 'Push Docker'
                script {
                    docker.withRegistry( '', registryCredential) {
                        dockerImage.push() 
                    }
                }
            }
        }
        
        stage('Docker Run ğŸŒ»') {
            steps {
                echo 'Pull Docker Image & Docker Image Run'
                sshagent (credentials: ['ssh_key']) {
                    sh "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker pull ${imagename}'" 
                    sh "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker ps -q --filter name=${containerName} | grep -q . && docker rm -f \$(docker ps -aq --filter name=${containerName})'"
                    sh "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker run -d --name ${containerName} -p 8080:8080 ${imagename}'"
                    sh "ssh -o StrictHostKeyChecking=no ubuntu@43.200.252.25 'docker rmi -f \$(docker images --filter ${noneFile} -q)'"
                }
            }
        }
        
    }
}
```










