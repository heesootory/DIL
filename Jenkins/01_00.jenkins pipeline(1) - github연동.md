# jenkins pipeline(github + dockerhub + slack ì—°ë™)

<br>
<br>
<br>

## ğŸŒˆ ì„¤ê³„ êµ¬ì¡°ë„

> ë„ì „!!!

<img 
    src = "../Image/jenkins/35.png"
    width = 800px
    height = 500px   
/>


<br>
<br>
<br>

## ğŸŒˆ êµ¬ì„± ìš”ì†Œ

* Jenkins server: AWS EC2 Ubuntu 20.04
* Deploy server: AWS EC2 Ubuntu 20.04
* Github Repository
* Docker Hub Repository
* Slack

<br>
<br>

## ğŸŒˆ ì§„í–‰ ê³¼ì •







<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ 0. CI/CD ë¥¼ êµ¬ì¶•í•˜ê¸° ì „ ì´ˆê¸° ì„¸íŒ…

<br>
<br>

### ğŸ³ ê°„ë‹¨í•œ springboot í”„ë¡œì íŠ¸ ìƒì„± & git repoì™€ ì—°ê²°

<img 
    src = "../Image/jenkins/36.png"
    width = 800px
    height = 400px   
/>
<img 
    src = "../Image/jenkins/37.png"
    width = 800px
    height = 400px   
/>

### ğŸ³ jenkins server ì™€ deploy server ê³µí†µ ì´ˆê¸° ì„¸íŒ…

### ğŸ¯ 1. EC2 ì´ˆê¸° ì„¸íŒ…

* ìµœì‹ í™”

```zsh
$ sudo apt update
$ sudo apt upgrade -y
```

* ë„¤íŠ¸ì›Œí¬ ê´€ë ¨ íˆ´ ì„¤ì¹˜

```zsh
$ apt-get install net-tools
```

* buildì— í•„ìˆ˜ì ì¸ ì„¸íŒ…ë“¤ ì„¤ì¹˜(jenkins serverë§Œ í•´ë‹¹)

```zsh
$ sudo apt install build-essential
```


### ğŸ¯ 2. docker ì„¤ì¹˜

* aptê°€ HTTPSë¥¼ í†µí•´ ì €ì¥ì†Œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ íŒ¨í‚¤ì§€ ì„¤ì¹˜.

```zsh
$ sudo apt install apt-transport-https ca-certificates curl 
$ software-properties-common
```

* ìë™ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ í™œìš©
    - ë¦¬ëˆ…ìŠ¤ ë°°í¬íŒ ì¢…ë¥˜ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•˜ì—¬ Docker íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œê³µ

```zsh
$ sudo wget -qO- https://get.docker.com/ | sh
```


### ğŸ¯ 3. docker ì„œë¹„ìŠ¤ ì‹¤í–‰ ë° ë¶€íŒ… ì‹œ ìë™ ì‹¤í–‰ ì„¤ì •

```zsh
$ sudo systemctl start docker
$ sudo systemctl enable docker      // í™œì„±í™”
$ sudo service docker status        // ìƒíƒœ í™•ì¸
```


### ğŸ¯ 4. ë„ì»¤ ê·¸ë£¹ì— í˜„ì¬ ê³„ì •ì„ ì¶”ê°€

* sudo ì‚¬ìš©í•˜ì§€ ì•Šê³  docker ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ubunut ì‚¬ìš©ìë¥¼ ë„ì»¤ ê·¸ë£¹ì— ì¶”ê°€í•œë‹¤.
* docker ê·¸ë£¹ì€ rootê¶Œí•œê³¼ ë™ì¼í•˜ë¯€ë¡œ, ê¼­ í•„ìš”í•œ ê³„ì •ë§Œ ë“±ë¡.

```zsh
$ sudo usermod -aG docker ${USER}
// sudo usermod -aG docker ${ubuntu}
$ sudo systemctl restart docker
```

* ìœ„ì˜ ì‘ì—… ì§„í–‰ í›„, í˜„ì¬ ê³„ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸ í–ˆì„ ë•Œ ì ìš©.

### ğŸ¯ 5. docker ì„¤ì¹˜ í™•ì¸

```zsh
$ docker -v
```


<br>
<br>
<hr>
<br>
<br>


### ğŸ³ jenkins server ì„¸íŒ….

### ğŸ¯ jenkins ì„¤ì¹˜

* jenkins image pull
    - í˜„ì¬(23.01.20 ê¸°ì¤€ lts ë²„ì ¼ ë‹¤ìš´)
```zsh
$ docker pull jenkins/jenkins:lts-jdk11
```

* jenkins container ë„ìš°ê¸°
    - í¬íŠ¸í¬ì›Œë”© 
        - 8080 : 8080
            - ì  í‚¨ìŠ¤ gui ì»¨íŠ¸ë¡¤ í¬íŠ¸.
        - 50000 : 50000
    
    - ë³¼ë¥¨ ë§ˆìš´íŠ¸()
        - /home/ubuntu/.ssh : /root/.ssh
            - ì¶”í›„ SSH ë¡œ deploy serverì— ì ‘ì†í•˜ê¸° ìœ„í•œ RSA í‚¤ë¥¼ jenkins server(ubuntu)ì™€ jenkins containerì—ì„œ ê³µìœ í•˜ê¸° ìœ„í•œ ë§ˆìš´íŠ¸.
        - /var/run/docker.sock : /var/run/docker.sock
            - docker in docker ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ë§ˆìš´íŠ¸.
```zsh
$ docker run -d -p 8080:8080 -p 50000:50000 -v /jenkins:/var/jenkins -v /home/ubuntu/.ssh:/root/.ssh -v /var/run/docker.sock:/var/run/docker.sock --name jenkins -u root jenkins/jenkins:lts-jdk11
```



### ğŸ¯ swap ë©”ëª¨ë¦¬ í• ë‹¹í•˜ê¸°

> jenkins ê°€ ë¹Œë“œë¥¼ ì§„í–‰ì‹œ, ìì£¼ ì£½ê²Œë˜ëŠ” ë¬¸ì œë¥¼ ê²ªê²Œ ë˜ëŠ”ë°, í”„ë¦¬í‹°ì–´ ë²„ì ¼ì´ ê¸°ë³¸ RAMì´ 1GB ì—¬ì„œ ìƒê¸°ëŠ” ë¬¸ì œì´ë‹¤.

* 2GB(128MB * 16) swap íŒŒì¼ì„ ë§Œë“¤ì–´ í• ë‹¹í•˜ì.

```zsh
$ sudo dd if=/dev/zero of=/swapfile bs=128M count=16
$ sudo chmod 600 /swapfile
$ sudo mkswap /swapfile
$ sudo swapon /swapfile
$ sudo swapon -s
$ sudo vi /etc/fstab
// ìœ„ì˜ íŒŒì¼ì— ì¶”ê°€í•˜ê¸° -> /swapfile swap swap defaults 0 0
```


<br>
<br>
<hr>
<br>
<br>



## ğŸŒˆ 1. Git hub ì—°ë™(Git hub hook + Git clone)

<br>
<br>

### ğŸ³ Plugin ì„¤ì¹˜

> Github Integration í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜.

<br>
<br>


### ğŸ³ SSH ìë™ì ‘ì†ì„ ìœ„í•œ rsa í‚¤ ë“±ë¡.

> RSA ì¸ì¦í‚¤ë¥¼ ì´ìš©í•´ì„œ, jenkins serverì—ì„œ git hub ì›ê²©ì €ì¥ì†Œì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •.

<br>


#### ğŸ¯ jenkins server(EC2 ë‚´ì—ì„œ) SSHí‚¤ë¥¼ ìƒì„±.

* í˜„ì¬ EC2ì˜ ì‚¬ìš©ìê°€ ubuntuë¡œ ë˜ì–´ìˆìœ¼ë¯€ë¡œ, /home/ubuntu/.ssh ì— SSH í‚¤(id_rsa, id_rsa.pub)ê°€ ìƒì„±ëœë‹¤.

```zsh
$ ssh-keygen
// ì„¤ì •ì€ ëª¨ë‘ enter ì¹˜ê³ , defaultë¡œ ì„¤ì •.
```

#### ğŸ¯ git repositoryì˜ deploy key ë“±ë¡.

* Github Repository > Settings > Deploy Keys > Add deploy key
* Titleì€ (jenkins) ì•„ë¬´ê±°ë‚˜ ì§€ì–´ì¤Œ.
* key ë¶€ë¶„ì— jenkins serverê°€ ìƒì„±í•œ public key(id_rsa.pub)ë¥¼ ë„£ì–´ì¤€ë‹¤.

```zsh
$ cd /home/ubuntu/.ssh
$ cat id_rsa.pub        // ê³µê°œí‚¤
```

#### ğŸ¯ jenkins credentials ë“±ë¡í•˜ê¸°.
(ì´ ë°©ë²• ë§ê³ , ì‹¤ì œë¡œëŠ” Username with password ë°©ì‹ìœ¼ë¡œ ì—°ë™ë¨.)

* Jenkins ëŒ€ì‹œë³´ë“œ > Jenkins ê´€ë¦¬ > Manage Credentials > Credentials

* Global credentials (unrestricted) ì— Add credentialsë¥¼ ì´ìš©í•´ credentialsë¥¼ ì¶”ê°€.

<img 
    src = "../Image/jenkins/38.png"
    width = 800px
    height = 500px   
/>

* New credentials ë‚´ìš©
    - kind : SSH Username with private key
    - ID : github_key(Pipeline Script ì‘ì„± ì‹œ credentialsIdë¡œ ì‚¬ìš©ë  ì´ë¦„.)
    - Username : root(default)
    - Private Key
        - Enter directly > key : ì´ê³³ì— githubì— ê³µê°œí•œ í‚¤ì˜ ë°˜ëŒ€ì¸ ê°œì¸í‚¤ë¥¼ ë„£ì.
        ```zsh
        $ cd /home/ubuntu/.ssh
        $ cat id_rsa
        ```

<br>
<br>

### ğŸ³ git-hub web hook ì¶”ê°€.

* Github Repositoryì—ì„œ Settings > Webhooks > Add Webhook 

* Payload URL
    - [Jenkins Server URL]:[Jenkins Server í¬íŠ¸]/github-webhook/

* Content type
    - application/x-www-form-urlencoded

<br>
<br>

### ğŸ³ pipeline ì‘ì„±

<br>
<br>

#### ğŸ¯ êµ¬ì„± ì •ë³´

<img 
    src = "../Image/jenkins/39.png"
    width = 700px
    height = 500px   
/>

* Github project ì„¤ì •
    - Pipeline êµ¬ì„± í™”ë©´ > General ì˜ì—­ì—ì„œ Github projectë¥¼ ì„ íƒ. Project urlì— ë³¸ì¸ì˜ Github Repository Urlì„ ì…ë ¥(ì´ ë•Œ Repository Urlì€ Clone ì‹œ ì‚¬ìš©í•˜ëŠ” HTTPS Url(.gitìœ¼ë¡œ ëë‚¨)ì„ ì…ë ¥)

* Build Triggers ì„¤ì •
    - Pipeline êµ¬ì„± í™”ë©´ > Build Triggers ì˜ì—­ì—ì„œ GitHub hook trigger for GITScm pollingì„ ì„ íƒ.


#### ğŸ¯ pipeline script

```groovy
pipeline {
    agent any

    stages {
        stage('Git Clone ğŸ¦Š') {
          steps {
            git url: 'https://github.com/heesootory/jenkins_pipe_test.git',
                branch: 'main',
                credentialsId: 'github_token'
            }
        }
    }
}
```


<img 
    src = "../Image/jenkins/41.png"
    width = 700px
    height = 500px   
/>





