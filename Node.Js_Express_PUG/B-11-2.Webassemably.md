# Webassembly

<br>

## index

<br>

---

<br>


## Transcode Video

### FFmpeg.wasm ì„¤ì¹˜

[https://github.com/ffmpegwasm/ffmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm)

```bash
$ npm install @ffmpeg/ffmpeg @ffmpeg/core
```

### FFmpeg instance ìƒì„±

```js
import { createFFmpeg, fetchFile} from "@ffmpeg/ffmpeg";
```

```js
const ffmpeg = createFFmpeg({log : true});
    await ffmpeg.load();
```

* {log:true} : ì–´ë–¤ ì¼ì´ ì¼ì–´ë‚˜ëŠ”ì§€ ì½˜ì†”ì—ì„œ ì „ë¶€ í™•ì¸í•˜ê¸° ìœ„í•¨.

* await ffmpeg.load() : ì‚¬ìš©ìê°€ ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ì•„ë‹Œ, ffmpeg ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ì„¤ì¹˜í•˜ì—¬ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ, load() ë¡œ ì„¤ì¹˜í•˜ëŠ” ê³¼ì •ì„ awaití•´ì¤˜ì•¼ í•¨.<br>
-> ìš°ë¦¬ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ë‹¤ë¥¸ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ê²ƒ.<br>
-> swê°€ ë¬´ê±°ìš¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, awaitë¥¼ ê¼­ í•´ì¤˜ì•¼í•œë‹¤.<br>
-> ì‚¬ìš©ìì˜ ì»´í“¨í„°ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ë‹¤ë¥¸ ì²˜ë¦¬ëŠ” ì•ˆí•´ì¤˜ë„ ëœë‹¤.<br>

> ì´ì œ Webassemblyë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆìœ¼ë¯€ë¡œ, ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ê°€ìƒì˜ ì»´í“¨í„°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ê³  ìƒê°í•˜ê³  ì§„í–‰í•˜ë©´ ëœë‹¤. 
> ì´ ê°€ìƒì˜ ì„¸ê³„ë¥¼ ffmpeg ì„¸ê³„ë¼ê³  ìƒê°í•´ ë³´ì.

### ffmpeg ì„¸ê³„ì— íŒŒì¼ì„ ìƒì„±.

```js
ffmpeg.FS("writefile", "recording.webm", await fetchFile(videofile));
```

```js
ffmpeg.FS("ì„¤ì •", "íŒŒì¼ëª…", await fetchfile(ë°›ì„íŒŒì¼));
```

* ffmpeg.FS : FileSystem 
    - 1. writefile : ffmpeg ê°€ìƒì˜ ì„¸ê³„ì— íŒŒì¼ì„ ìƒì„±<br>
    - 2. readfile <br>
    - 3. unlink <br>
    ë“±ì˜ ì„¤ì •ì´ ì¡´ì¬.

* binaryData function : fetchí•  fileì´ videofileì´ê³  ì´ íŒŒì¼ì€ binary ì •ë³´ë¡œ ê¸°ë¡ëœ, BlobíŒŒì¼ì´ë¯€ë¡œ, "fetchfile"í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ fetchë¥¼ ì§„í–‰.

> ë°±ì—”ë“œì—ì„œ multerê°€ íŒŒì¼ ìƒì„±ì„ ë„ì™€ì¤¬ë˜ê²ƒê³¼ ë§ˆì°®ê°€ì§€ë¡œ, í”„ë¡ íŠ¸ë‹¨ì—ì„œ ffmpegê°€ ë„ì™€ì¤€ë‹¤ê³  ìƒê°.
> í”„ë¡ íŠ¸ì—ì„œë„ multerê°€ avatarí´ë”ë¥¼ ë§Œë“¤ì–´ì¤€ê²ƒê³¼ ë¹„ìŠ·í•œ í´ë”ë¥¼ ìƒì„±í•œë‹¤ê³  ìƒê°í•˜ì.

```js
await ffmpeg.run("-i", "recording.webm","-r", "60", "output.mp4");
```

```js
await ffmpeg.run("ì˜µì…˜", "íŒŒì¼ëª…", "output íŒŒì¼")
```

* run : ffmpegê°€ ì´ë¯¸ ê°€ìƒì˜ ì»´í“¨í„°ì— ì¡´ì¬í–ˆë˜, "recording.webm"ì„ "-i" (input) ì…ë ¥ ë°›ê³ , "output.mp4"ë¼ëŠ” íŒŒì¼ë¡œ ë³€í™˜.

* "-i" : input

* "-r", "60" : ì´ˆë‹¹ 60í”„ë ˆì„ìœ¼ë¡œ ì¸ì½”ë”© ì„¤ì •. <br>
    -> ë” ë¹ ë¥¸ ì˜ìƒ ì¸ì½”ë”©ì´ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •.

> ffmpeg ì„¸ê³„ì˜ ê°€ìƒì˜ ì»´í“¨í„°ì— ë³€í™˜ëœ íŒŒì¼ output.mp4íŒŒì¼ì´ ì €ì¥ë˜ì–´ ìˆëŠ” ìƒíƒœ.


![api](/Image/Express/z31.png)

> ì •ìƒì ìœ¼ë¡œ ì¸ì½”ë”©


### ì˜¤ë¥˜ê´€ë ¨

1. Uncaught ReferenceError: createFFmpegCore is not defined ì˜¤ë¥˜ í•´ê²° ë°©ë²•

![api](/Image/Express/z32.png)

"http://localhost:3000/node_modules/@ffmpeg/core/dist/"ì—ì„œ ffmpeg-core.js, ffmpeg-core.wasm, ffmpeg-core.worker.jsíŒŒì¼ë“¤ì„ ì°¾ì§€ ëª»í•´ ìƒê¸°ëŠ” ì—ëŸ¬ì´ê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì´ corePathë¥¼ ì§€ì •í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
[https://github.com/ffmpegwasm/ffmpeg.wasm#why-it-doesnt-work-in-my-local-environment](https://github.com/ffmpegwasm/ffmpeg.wasm#why-it-doesnt-work-in-my-local-environment)
```
createFFmpeg({
corePath: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js',
log: true
});
```

![api](/Image/Express/z33.png)

2. Uncaught (in promise) ReferenceError: SharedArrayBuffer is not defined ì˜¤ë¥˜ í•´ê²° ë°©ë²•

FFmpegë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ, ì½˜ì†”ì°½ì— ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë‚œë‹¤ë©´ server.jsì— app.set()ì•„ë˜ì— í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

ì˜¤ë¥˜ ì›ì¸ : SharedArrayBufferëŠ” cross-origin isolatedëœ í˜ì´ì§€ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ffmpeg.wasmì„ ì‚¬ìš©í•˜ë ¤ë©´ Cross-Origin-Embedder-Policy: require-corp ë° Cross-Origin-Opener-Policy: same-originë¥¼ headerì— ì„¤ì •í•´ ìì²´ ì„œë²„ë¥¼ í˜¸ìŠ¤íŒ…í•´ì•¼ í•©ë‹ˆë‹¤.
[https://github.com/ffmpegwasm/ffmpeg.wasm/issues/263](https://github.com/ffmpegwasm/ffmpeg.wasm/issues/263)

```
// server.js
app.use((req, res, next) => {
res.header("Cross-Origin-Embedder-Policy", "require-corp");
res.header("Cross-Origin-Opener-Policy", "same-origin");
next();
});
```

![api](/Image/Express/z34.png)



## Download Transcode Video

### ë³€í™˜ëœ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°

```js
    const mp4file = ffmpeg.FS("readFile", "output.mp4");
```

* FSì˜ "readfile"ì„ ì´ìš©í•´ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°.

![api](/Image/Express/z36.png)

> ë¶ˆëŸ¬ì˜¨ íŒŒì¼ì„ console.logë¡œ í™•ì¸í•´ë³´ì.

![api](/Image/Express/z35.png)
![api](/Image/Express/z37.png)

* ë¬´ë ¤ 179824 ìë¦¬ì˜ ë°°ì—´ì´ ë§Œë“¤ì–´ ì§„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

* ì´ê²Œ ê³§ ë…¹í™” ì˜ìƒì˜ ë°ì´í„°ì´ê³ , unsigned Integer8(ìŒìˆ˜X, ì–‘ìˆ˜ë§Œ ì¡´ì¬)ì˜ typeìœ¼ë¡œ ì €ì¥ëœë‹¤.

> ë§ˆì¹˜ ì»´í“¨í„°ì— ì €ì¥ë˜ì–´ ìˆëŠ” íŒŒì¼ì²˜ëŸ¼ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ ìˆìŒ.

> ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´, jsíŒŒì¼ë¡œ ë°”ê¿”ì¤˜ì•¼í•˜ëŠ”ë°  ê·¸ê²Œ ë°”ë¡œ Blobì´ë‹¤.

* Blob 
    - ìë°”ìŠ¤í¬ë¦½íŠ¸ ì„¸ê³„ì˜ íŒŒì¼.
    - ì‹¤ì œë¡œëŠ” íŒŒì¼ ê°™ì€ ê°ì²´.
    - binary ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” íŒŒì¼.

#### Uint8Array & buffer

[Uint8Array - https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array)

* Uint8Array
    - ìš°ë¦¬ê°€ í•˜ê³  ì‹¶ì€ëŒ€ë¡œ ë§Œì§ˆ ìˆ˜ ìˆëŠ” byte ë°ì´í„°.
    - byteë¥¼ ì‚­ì œ, ì••ì¶•, ìˆ˜ì • ë­ë“  ê°€ëŠ¥í•˜ë‹¤.

* buffer
    - Uint8Array ì˜ ì‹¤ì œ ë°ì´í„°ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•´ì•¼í•¨.

> Uint8Array ë°ì´í„°ë¥¼ Blobìœ¼ë¡œ ë³€í™˜ì‹œí‚¬ ìˆ˜ëŠ” ì—†ì§€ë§Œ, ArrayBufferë°ì´í„°ëŠ” ë³€í™˜ì´ ê°€ëŠ¥.
> Uint8Array ëŠ” ì‹¤ì œ íŒŒì¼ì˜ ë°ì´í„° ì¦‰, raw data, binary dataì˜ data ë°°ì—´ì„ë³´ì—¬ì£¼ê³  ìˆë‹¤.

ğŸ”¥ ê²°ë¡  : binary data(raw data)ë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ìœ¼ë©´, bufferë¥¼ ì‚¬ìš©í•´ë¼!

### Blob ìƒì„±

```js
const Blobmp4 = new Blob([mp4file.buffer], {type : "video/mp4"});
```

* new Blob([ë°ì´í„° ë°°ì—´ì„ ë°›ì„ìˆ˜ ìˆë‹¤.])

* {type : "video/mp4"} : jsì—ê²Œ typeì„ ê¼­ ì•Œë ¤ì£¼ê¸°.


### Blob URL ìƒì„±

```js
const mp4URL = URL.createObjectURL(Blobmp4);
```

![api](/Image/Express/z37.png)

> mp4ë¡œ ë³€í™˜ëœ Blobì˜ URLì„ ë§Œë“¤ì–´ì£¼ê³ , ê·¸ê±¸ ë§í¬ë¡œ ë°›ì•„ì¤Œìœ¼ë¡œì¨, 
mp4íŒŒì¼ë¡œ ë‹¤ìš´ë°›ê¸° ì™„ë£Œ.



## Thumbnail ë§Œë“¤ê¸°

```js
await ffmpeg.run("-i", "recording.webm", "-ss", "00:00:01", "-frames:v" , "1", "thumbnail.jpg");
```

* "-i" : input
* "recoring.webm" : íŒŒì¼ì„ ë°›ì•„ì„œ,
* "-ss" : ì°¾ëŠ”ë‹¤.(seek)
* "00:00:01" : í•´ë‹¹ì‹œê°„ì„,
* "-frame:v" , "1" : 1ì¥ì„ ìŠ¤í¬ë¦¿ìƒ·ìœ¼ë¡œ ì°ê³ ,
* "thumbnail.jpg" : ì¸ë„¤ì¼ íŒŒì¼ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.

> ì´ íŒŒì¼ì€ FS(íŒŒì¼ì‹œìŠ¤í…œ) ë©”ëª¨ë¦¬ì— ì €ì¥ëœë‹¤.

![api](/Image/Express/z39.png)

> jpgíŒŒì¼ì´ ìƒì„±ëœ ê±¸ í™•ì¸ ê°€ëŠ¥.

![api](/Image/Express/z40.png)

> ì˜ìƒê³¼ ë§ˆì°®ê°€ì§€ë¡œ BlobURlìƒì„±.

## ì†ë„ ì œì–´

> ë„ˆë¬´ë§ì€ íŒŒì¼ë“¤ì„ ê³„ì† ë“¤ê³ ìˆìœ¼ë©´, ëŠë ¤ì§ìœ¼ë¡œ, í•„ìš”ì—†ëŠ” íŒŒì¼ë“¤ì€ ì—°ê²°ì„ í•´ì œ ì‹œì¼œì£¼ì.

* unlink : ë©”ëª¨ë¦¬ì—ì„œ í•´ì œ.

* revokebjectURL : URL ì—°ê²° í•´ì œ.

![api](/Image/Express/z42.png)

![api](/Image/Express/z44.png)


## Thumbnail upload

### ì½”ë“œ ì •ë¦¬

> ëª¨ë‘ stringìœ¼ë¡œ ì ì–´ì£¼ë©´, ì‹¤ìˆ˜ê°€ ë§ì•„ì§ìœ¼ë¡œ, ê°ì²´ë¡œ ë¬¶ê¸°.



















