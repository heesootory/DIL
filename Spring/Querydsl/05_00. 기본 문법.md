# ê¸°ë³¸ ë¬¸ë²•


<br>
<br>
<br>

## ğŸŒˆ JPQL vs Querydsl ë¹„êµ

<br>

* JPQL: ë¬¸ì(runtime ì‹œì  ì˜¤ë¥˜) / Querydsl: ì½”ë“œ(ì»´íŒŒì¼ ì‹œì  ì˜¤ë¥˜)

* JPQL : íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì§ì ‘ / Querydsl : íŒŒë¼ë””í„° ë°”ì¸ë”© ìë™ ì²˜ë¦¬.



* JPQL

    ```java
    @Test
    public void startJPQL() {
        //member1ì„ ì°¾ì•„ë¼.
        String qlString =
            "select m from Member m " +
            "where m.username = :username";

        Member findMember = em.createQuery(qlString, Member.class)
                                .setParameter("username", "member1")
                                .getSingleResult();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }
    ```

* Querydsl

    - EntityManager ë¡œ JPAQueryFactory ìƒì„±
    - Querydslì€ JPQL ë¹Œë”
    - JPAQueryFactory queryFactory = new JPAQueryFactory(em); ë¥¼ í•„ë“œë¡œ ê°€ì ¸ë„ ë™ì‹œì„± ë¬¸ì œê°€ ì—†ê²Œ ì„¤ê³„ë˜ì—ˆë‹¤.(ìŠ¤í”„ë§ í”„ë ˆì„ì›Œí¬ì—ì„œ ì£¼ì…í•´ì£¼ëŠ” ì—”í‹°í‹° ë§¤ë‹ˆì €ê°€ ë©€í‹° ì“°ë ˆë“œê°€ ê°€ëŠ¥í•˜ê²Œ ì„¤ê³„ë¨.)

    ```java
    @Test
    public void startQuerydsl() {
        //member1ì„ ì°¾ì•„ë¼.
        JPAQueryFactory queryFactory = new JPAQueryFactory(em);
        QMember m = new QMember("m");

        Member findMember = queryFactory
                                .select(m)
                                .from(m)
                                .where(m.username.eq("member1"))//íŒŒë¼ë¯¸í„° ë°”ì¸ë”© ì²˜ë¦¬
                                .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }
    ```

<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ê¸°ë³¸ Q-Type í™œìš©

<br>

* Qí´ë˜ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” 2ê°€ì§€ ë°©ë²•
    - ê°™ì€ í…Œì´ë¸”ì„ ì¡°ì¸í•˜ëŠ” ê²½ìš°ì—ë§Œ ë³„ì¹­ì„ ì§ì ‘ ì§€ì •í•´ì„œ ì‚¬ìš©í•˜ê³ , ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ê¸°ë³¸ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì!
    
        ```java
        QMember qMember = new QMember("m");     //ë³„ì¹­ ì§ì ‘ ì§€ì •
        QMember qMember = QMember.member;   //ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©
        ```


* ê¸°ë³¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ static importì™€ í•¨ê»˜ ì‚¬ìš©.

    ```java
    import static study.querydsl.entity.QMember.*;

    @Test
    public void startQuerydsl3() {
        //member1ì„ ì°¾ì•„ë¼.
        Member findMember = queryFactory
                                .select(member)
                                .from(member)
                                .where(member.username.eq("member1"))
                                .fetchOne();
                            
        assertThat(findMember.getUsername()).isEqualTo("member1");
    }
    ```

* JPQL ì¿¼ë¦¬ë¡œ í™•ì¸í•˜ê¸°
    - ê²°êµ­ Querydslë„ JPQL ì¿¼ë¦¬ë¡œ ë°”ë€ í›„ ì²˜ë¦¬ ëœë‹¤.
    - Querydsl ì€ JPQLì˜ ë¹Œë” ì—­í• !
    - yml íŒŒì¼ì— ì¶”ê°€í•˜ë©´ ì‹¤í–‰ë˜ëŠ” JQPLì„ ë³¼ ìˆ˜ ìˆë‹¤.
        ```java
        spring.jpa.properties.hibernate.use_sql_comments: true
        ``` 


<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ê²€ìƒ‰ ì¡°ê±´ ì¿¼ë¦¬


<br>

* select ê³¼ from ì€ í•©ì³ì„œ selectFromìœ¼ë¡œ ì‚¬ìš©ê°€ëŠ¥.

* ì¡°ê±´ë¬¸ where
    - and ë‚˜ orì„ ì´ìš©í•´ì„œ ë©”ì„œë“œ ì²´ì¸ìœ¼ë¡œ ì—°ê²° ê°€ëŠ¥.

* ì˜ˆì‹œ ì½”ë“œ
    ```java
    @Test
    public void search() {
        Member findMember = queryFactory
                            .selectFrom(member)
                            .where(member.username.eq("member1")
                            .and(member.age.eq(10)))
                            .fetchOne();

        assertThat(findMember.getUsername()).isEqualTo("member1");
    }
    ```

* AND ì¡°ê±´ì€ -> ","(ì½¤ë§ˆ) ë¡œ ì²˜ë¦¬ ê°€ëŠ¥.
    - ì½¤ë§ˆ ì¤‘ê°„ì— ë“¤ì–´ì˜¤ëŠ” nullì€ ë¬´ì‹œí•œë‹¤. -> ì¶”í›„ ë™ì  ì¿¼ë¦¬ë¥¼ ë§Œë“¤ë•Œ ê¹”ë”í•˜ê²Œ ì§¤ ìˆ˜ ìˆë‹¤.




<br>
<br>

### ğŸ³ JPQLì´ ì œê³µí•˜ëŠ” ëª¨ë“  ê²€ìƒ‰ ì¡°ê±´ ì œê³µ

```java
member.username.eq("member1") // username = 'member1'
member.username.ne("member1") //username != 'member1'
member.username.eq("member1").not() // username != 'member1'
member.username.isNotNull() //ì´ë¦„ì´ is not null

member.age.in(10, 20) // age in (10,20)
member.age.notIn(10, 20) // age not in (10, 20)
member.age.between(10,30) //between 10, 30
member.age.goe(30) // age >= 30
member.age.gt(30) // age > 30
member.age.loe(30) // age <= 30
member.age.lt(30) // age < 30

member.username.like("member%") //like ê²€ìƒ‰
member.username.contains("member") // like â€˜%member%â€™ ê²€ìƒ‰
member.username.startsWith("member") //like â€˜member%â€™ ê²€ìƒ‰
```


<br>
<br>
<hr>
<br>
<br>



## ğŸŒˆ ê²°ê³¼ ì¡°íšŒ

* fetch() : ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ, ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
* fetchOne() : ë‹¨ ê±´ ì¡°íšŒ
    - ê²°ê³¼ê°€ ì—†ìœ¼ë©´ : null
    - ê²°ê³¼ê°€ ë‘˜ ì´ìƒì´ë©´ : com.querydsl.core.NonUniqueResultException
* fetchFirst() : limit(1).fetchOne() ->  ì²˜ìŒ í•œê±´ ì¡°íšŒ.
* fetchResults() : í˜ì´ì§• ì •ë³´ í¬í•¨, total count ì¿¼ë¦¬ ì¶”ê°€ ì‹¤í–‰
* fetchCount() : count ì¿¼ë¦¬ë¡œ ë³€ê²½í•´ì„œ count ìˆ˜ ì¡°íšŒ



* ì˜ˆì‹œ ì½”ë“œ
    ```java
    //í˜ì´ì§•ì—ì„œ ì‚¬ìš© -  í˜ì´ì§•ì—ì„œ í™œìš©ë  ìˆ˜ ìˆëŠ” ë‹¤ì–‘í•œ í•¨ìˆ˜ë“¤ì„ í™œìš©.
    QueryResults<Member> results = queryFactory
    .selectFrom(member)
    .fetchResults();

    results.getTotal(); // ì¹´ìš´íŠ¸ë§Œ ì¶œë ¥.
    List<Member> content = results.getResults();    // ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥.


    //count ì¿¼ë¦¬ë¡œ ë³€ê²½
    long count = queryFactory
    .selectFrom(member)
    .fetchCount();

    ```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ ì •ë ¬

<br>

* ì£¼ìš” í•¨ìˆ˜ ì •ë¦¬
    - desc(), asc() : ì¼ë°˜ ì •ë ¬.
    - nullsLast(), nullsFirst() : null ë°ì´í„° ìˆœì„œ ë¶€ì—¬.

* ì˜ˆì‹œì½”ë“œ

```java
/**
* íšŒì› ì •ë ¬ ìˆœì„œ
* 1. íšŒì› ë‚˜ì´ ë‚´ë¦¼ì°¨ìˆœ(desc)
* 2. íšŒì› ì´ë¦„ ì˜¬ë¦¼ì°¨ìˆœ(asc)
* ë‹¨ 2ì—ì„œ íšŒì› ì´ë¦„ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ì— ì¶œë ¥(nulls last)
*/
@Test
public void sort() {
    em.persist(new Member(null, 100));
    em.persist(new Member("member5", 100));
    em.persist(new Member("member6", 100));

    List<Member> result = queryFactory
                            .selectFrom(member)
                            .where(member.age.eq(100))
                            .orderBy(member.age.desc(), member.username.asc().nullsLast())
                            .fetch();

    Member member5 = result.get(0);
    Member member6 = result.get(1);
    Member memberNull = result.get(2);

    assertThat(member5.getUsername()).isEqualTo("member5");
    assertThat(member6.getUsername()).isEqualTo("member6");
    assertThat(memberNull.getUsername()).isNull();
}
```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ í˜ì´ì§•

<br>


* ì˜ˆì‹œì½”ë“œ
    - ì¡°íšŒ ê±´ìˆ˜ ì œí•œ.
        ```java
        @Test
        public void paging1() {
            List<Member> result = queryFactory
                                    .selectFrom(member)
                                    .orderBy(member.username.desc())
                                    .offset(1) //0ë¶€í„° ì‹œì‘(zero index)
                                    .limit(2) //ìµœëŒ€ 2ê±´ ì¡°íšŒ
                                    .fetch();

            assertThat(result.size()).isEqualTo(2);
        }
        ```

    - ì „ì²´ ì¡°íšŒ ìˆ˜ê°€ í•„ìš”í• ë•Œ
        - count ì¿¼ë¦¬ê°€ ë¨¼ì € ì‹¤í–‰ëœ í›„ì— contentì— ê´€í•œ ì¿¼ë¦¬ê°€ ë‚˜ê°.
        - ì‹¤ì œë¡œëŠ” ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ëŠ” ì—¬ëŸ¬ í…Œì´ë¸”ì„ ì¡°ì¸í•´ì•¼ í•˜ì§€ë§Œ, countì¿¼ë¦¬ëŠ” ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ê²½ìš°ë„ ì¡´ì¬í•  ìˆ˜ ìˆë‹¤.(left outer join) ê·¸ëŸ°ë° ì´ë ‡ê²Œ ìë™í™”ëœ count ì¿¼ë¦¬ëŠ” ì›ë³¸ ì¿¼ë¦¬ì™€ ê°™ì´ ëª¨ë‘ ì¡°ì¸ì„ í•´ë²„ë¦¬ê¸° ë•Œë¬¸ì— ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. countì¿¼ë¦¬ì— ì¡°ì¸ì´ í•„ìš”ì—†ëŠ” ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•˜ë‹¤ë©´, countì „ìš© ì¿¼ë¦¬ë¥¼ ë³„ë„ë¡œ ì‘ì„±í•˜ì.
    
    ```java
    @Test
    public void paging2() {
        QueryResults<Member> queryResults = queryFactory
                                            .selectFrom(member)
                                            .orderBy(member.username.desc())
                                            .offset(1)
                                            .limit(2)
                                            .fetchResults();

        assertThat(queryResults.getTotal()).isEqualTo(4);
        assertThat(queryResults.getLimit()).isEqualTo(2);
        assertThat(queryResults.getOffset()).isEqualTo(1);
        assertThat(queryResults.getResults().size()).isEqualTo(2);
    }
    ```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ ì§‘í•© - group by

<br>

* JQPLì´ ì œê³µí•˜ëŠ” ëª¨ë“  ì§‘í•© í•¨ìˆ˜ë¥¼ ì œê³µ.

* tupleì€ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ë°˜í™˜ì—ì„œ ì„¤ëª….
    - ì—¬ê¸°ì„œ tupleì˜ ì˜ë¯¸ : memberì™€ ê°™ì€ ë‹¨ì¼ íƒ€ì…ì´ ì•„ë‹ˆë¼, í˜„ì¬ resultì˜ ì›ì†Œ ì¤‘ í•˜ë‚˜ëŠ” member.count ~ member.age.minê°’ìœ¼ë¡œ ìˆ«ì 5ê°œë¡œ êµ¬ì„±ëœ ì—¬ëŸ¬ íƒ€ì…ì˜ ë¬¶ìŒì´ë¯€ë¡œ, ì´ëŸ° ê²½ìš°ì—ëŠ” tupleì„ ì‚¬ìš©í•´ì„œ ë°›ì„ ìˆ˜ ìˆë‹¤. (ì‚¬ì‹¤ ì‹¤ë¬´ì—ì„œ tupleì„ ë§ì´ ì‚¬ìš©í•˜ì§€ëŠ” âŒ)

```java
/**
* JPQL
* select
* COUNT(m), //íšŒì›ìˆ˜
* SUM(m.age), //ë‚˜ì´ í•©
* AVG(m.age), //í‰ê·  ë‚˜ì´
* MAX(m.age), //ìµœëŒ€ ë‚˜ì´
* MIN(m.age) //ìµœì†Œ ë‚˜ì´ * from Member m
*/

@Test
  public void aggregation() throws Exception {
      List<Tuple> result = queryFactory
              .select(member.count(),
                      member.age.sum(),
                      member.age.avg(),
                      member.age.max(),
                      member.age.min())
              .from(member)
              .fetch();
      Tuple tuple = result.get(0);

      assertThat(tuple.get(member.count())).isEqualTo(4);
      assertThat(tuple.get(member.age.sum())).isEqualTo(100);
      assertThat(tuple.get(member.age.avg())).isEqualTo(25);
      assertThat(tuple.get(member.age.max())).isEqualTo(40);
      assertThat(tuple.get(member.age.min())).isEqualTo(10);
}

```

<br>


```java
/**
* íŒ€ì˜ ì´ë¦„ê³¼ ê° íŒ€ì˜ í‰ê·  ì—°ë ¹ì„ êµ¬í•´ë¼.
*/

@Test
  public void group() throws Exception {
    // ì—¬ê¸°ì„œ member ì™€ team ëª¨ë‘ Qmember, Qteamì„ ì˜ë¯¸.
      List<Tuple> result = queryFactory
                .select(team.name, member.age.avg())
                .from(member)
                .join(member.team, team)
                .groupBy(team.name)
                .fetch();
        Tuple teamA = result.get(0);
        Tuple teamB = result.get(1);

        assertThat(teamA.get(team.name)).isEqualTo("teamA");
        assertThat(teamA.get(member.age.avg())).isEqualTo(15);
        assertThat(teamB.get(team.name)).isEqualTo("teamB");
        assertThat(teamB.get(member.age.avg())).isEqualTo(35);
  }
```

<br>
<br>

### ğŸ³ having

> group by, ê·¸ë£¹í™”ëœ ê²°ê³¼ë¥¼ ì œí•œí•˜ë ¤ë©´ having ì‚¬ìš©. (ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì€ ê²°ê³¼ë“¤ ì¤‘ ì¡°ê±´ ê±¸ê¸°)

```java
.groupBy(item.price)        // ê°€ê²©ìœ¼ë¡œ ê·¸ë£¹ì„ ë‚˜ëˆ ì„œ
.having(item.price.gt(1000))        // ê·¸ì¤‘ 1000ì›ì´ ë„˜ëŠ” ìˆ˜ë§Œ ì¶œë ¥í•´ë¼.
```


<br>
<br>
<br>
<br>

## ğŸŒˆ ì¡°ì¸ - ê¸°ë³¸ì¡°ì¸

<br>

* ì¡°ì¸ì˜ ê¸°ë³¸ ë¬¸ë²•
    - íŒŒë¼ë¯¸í„°1 : ì¡°ì¸ ëŒ€ìƒ.
    - íŒŒë¼ë¯¸í„°2 : ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•  Qíƒ€ì….
    ```java
    join(ì¡°ì¸ ëŒ€ìƒ, ë³„ì¹­ìœ¼ë¡œ ì‚¬ìš©í•  Qíƒ€ì…)
    ```

* join() , innerJoin() : ë‚´ë¶€ ì¡°ì¸(inner join) 

* leftJoin() : left ì™¸ë¶€ ì¡°ì¸(left outer join) 

* rightJoin() : rigth ì™¸ë¶€ ì¡°ì¸(rigth outer join)

* JPQLì˜ onê³¼ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ fetch ì¡°ì¸ ì œê³µ.

<br>

* ì˜ˆì‹œì½”ë“œ

```java
/**
*íŒ€Aì— ì†Œì†ëœ ëª¨ë“  íšŒì›
*/

@Test
public void join() throws Exception {
    QMember member = QMember.member;
    QTeam team = QTeam.team;

    List<Member> result = queryFactory
            .selectFrom(member)
            .join(member.team, team)
            .where(team.name.eq("teamA"))
            .fetch();
    
    assertThat(result)
            .extracting("username")     // ê° ì›ì†Œë“¤ì˜ í•„ë“œë¡œ ë‚˜ì—´.
            .containsExactly("member1", "member2");     // ê·¸ì¤‘ì— ë‹¤ìŒì˜ ì›ì†Œê°€ í¬í•¨ë˜ì–´ìˆëŠ”ì§€ë§Œ í™•ì¸
```


### ğŸ³ ì„¸íƒ€ì¡°ì¸

> ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” í•„ë“œë¡œ ì¡°ì¸

* fromì ˆì— ì—¬ëŸ¬ ì—”í‹°í‹°ë¥¼ ì„ íƒí•´ì„œ ë‚˜ì—´í•˜ëŠ” ë°©ë²•.

* ì™¸ë¶€ ì¡°ì¸ ë¶ˆê°€ëŠ¥!! -> ë‹¤ìŒì— ë‚˜ì˜¬ onì„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ ì¡°ì¸ ê°€ëŠ¥.

* ë‚´ë¶€ë™ì‘
    - ëª¨ë“  ì—”í‹°í‹°ë¥¼ ì „ë¶€ ë‹¤ ì¡°ì¸(ì¹´ë¥´í…Œì‹œì•ˆ ê³± ì¡°ì¸)ì‹œí‚¤ê³ , whereì ˆì—ì„œ í•„í„°ë§í•´ì„œ ê°€ì ¸ì˜´.

```java
@Test
public void theta_join() throws Exception {
    em.persist(new Member("teamA"));
    em.persist(new Member("teamB"));

    List<Member> result = queryFactory
        .select(member)
        .from(member, team)
        .where(member.username.eq(team.name))
        .fetch();
    
    assertThat(result)
        .extracting("username")     // ê° ì›ì†Œë“¤ì˜ í•„ë“œë¡œ ë‚˜ì—´.
        .containsExactly("teamA", "teamB");
}
```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ ì¡°ì¸ - onì ˆ

* onì ˆì„ í™œìš©í•œ ì¡°ì¸
    - ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§.
    - ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸.

* on ì ˆì€ joinì„ ì‹œí‚¤ê¸° ì´ì „ì— joinì˜ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì ˆë§Œ joinì‹œí‚¤ê¸° ìœ„í•œ ì¡°ê±´ë¬¸ì´ë‹¤.

```java
/**
* ì˜ˆ) íšŒì›ê³¼ íŒ€ì„ ì¡°ì¸í•˜ë©´ì„œ, íŒ€ ì´ë¦„ì´ teamAì¸ íŒ€ë§Œ ì¡°ì¸, íšŒì›ì€ ëª¨ë‘ ì¡°íšŒ
* JPQL: SELECT m, t FROM Member m LEFT JOIN m.team t on t.name = 'teamA'
* SQL: SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.TEAM_ID=t.id and
  t.name='teamA'
*/
@Test
public void join_on_filtering() throws Exception {
List<Tuple> result = queryFactory
                        .select(member, team)
                        .from(member)
                        .leftJoin(member.team, team).on(team.name.eq("teamA"))
                        .fetch();
    for (Tuple tuple : result) {
        System.out.println("tuple = " + tuple);
    } 
}
/**
ê²°ê³¼ - leftjoinì´ë¯€ë¡œ memberëŠ” ë‹¤ê°€ì ¸ì˜¤ê³ , team ì€ aíŒ€ë§Œ ê°€ì ¸ì˜´.
t=[Member(id=3, username=member1, age=10), Team(id=1, name=teamA)]
t=[Member(id=4, username=member2, age=20), Team(id=1, name=teamA)]
t=[Member(id=5, username=member3, age=30), null]
t=[Member(id=6, username=member4, age=40), null] 
ê²°ê³¼ - inner joinì„ í• ì‹œ
t=[Member(id=3, username=member1, age=10), Team(id=1, name=teamA)]
t=[Member(id=4, username=member2, age=20), Team(id=1, name=teamA)]
 */
```

> onì ˆì„ í™œìš©í•´ ì¡°ì¸ ëŒ€ìƒì„ í•„í„°ë§ í• ë•Œ, ì™¸ë¶€ì¡°ì¸ì´ ì•„ë‹ˆë¼ ë‚´ë¶€ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´, where ì ˆì—ì„œ í•„í„°ë§ í•˜ëŠ” ê²ƒê³¼ ê¸°ëŠ¥ì´ ë™ì¼. ë”°ë¼ì„œ on ì ˆì„ í™œìš©í•œ ì¡°ì¸ ëŒ€ìƒ í•„í„°ë§ì„ ì‚¬ìš©í•  ë•Œ, ë‚´ë¶€ì¡°ì¸ ì´ë©´ ìµìˆ™í•œ whereì ˆë¡œ í•´ê²°í•˜ê³  ì •ë§ ì™¸ë¶€ì¡°ì¸ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ onì‚¬ìš©í•˜ì!


<br>
<br>


### ğŸ³ ì—°ê´€ê´€ê³„ê°€ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸

* ì£¼ì˜í•  ì !
    - ë¬¸ë²•ì´ ì¼ë°˜ì¡°ì¸ê³¼ ë‹¤ë¥´ê²Œ leftjoin() ë¶€ë¶„ì— ì—”í‹°í‹°ê°€ í•˜ë‚˜ë§Œ ë“¤ì–´ê°€ê²Œ ëœë‹¤!
        - ì¼ë°˜ì¡°ì¸ : leftJoin(member.team, team)
        - on ì¡°ì¸ : from(member).leftJoin(team).on(xxx)



```java
/**
*2. ì—°ê´€ê´€ê³„ ì—†ëŠ” ì—”í‹°í‹° ì™¸ë¶€ ì¡°ì¸
*ì˜ˆ)íšŒì›ì˜ ì´ë¦„ê³¼ íŒ€ì˜ ì´ë¦„ì´ ê°™ì€ ëŒ€ìƒ ì™¸ë¶€ ì¡°ì¸
* JPQL: SELECT m, t FROM Member m LEFT JOIN Team t on m.username = t.name
* SQL: SELECT m.*, t.* FROM Member m LEFT JOIN Team t ON m.username = t.name */
@Test
public void join_on_no_relation() throws Exception {
    em.persist(new Member("teamA"));
    em.persist(new Member("teamB"));

    List<Tuple> result = queryFactory
            .select(member, team)
            .from(member)
            .leftJoin(team).on(member.username.eq(team.name))
            .fetch();

    for (Tuple tuple : result) {
        System.out.println("t=" + tuple);
    } 
}

/**
ê²°ê³¼
t=[Member(id=3, username=member1, age=10), null]
t=[Member(id=4, username=member2, age=20), null]
t=[Member(id=5, username=member3, age=30), null]
t=[Member(id=6, username=member4, age=40), null]
t=[Member(id=7, username=teamA, age=0), Team(id=1, name=teamA)]
t=[Member(id=8, username=teamB, age=0), Team(id=2, name=teamB)]
 */
```

<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ì¡°ì¸ - í˜ì¹˜ ì¡°ì¸

<br>

> í˜ì¹˜ ì¡°ì¸ì€ SQLì— ìˆëŠ” ê¸°ëŠ¥ âŒ

> ì£¼ë¡œ ì„±ëŠ¥ ìµœì í™”ì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•.

* ì‚¬ìš©ë°©ë²• : join()ì´ë‚˜ leftjoin() ë“± ì¡°ì¸ ê¸°ëŠ¥ ë’¤ì— fetchjoin()ë§Œ ì¶”ê°€.

* í˜ì¹˜ ì¡°ì¸ ë¯¸ì ìš©
    - ì§€ì—°ë¡œë”©ìœ¼ë¡œ Member, Team SQL ì¿¼ë¦¬ ê°ê° ì‹¤í–‰

```java
@PersistenceUnit
EntityManagerFactory emf;   // EntityManagerë¥¼ ë§Œë“œëŠ” íŒ©í† ë¦¬.

@Test
public void fetchJoinNo() throws Exception {
    em.flush();
    em.clear();

    Member findMember = queryFactory
                            .selectFrom(member)
                            .where(member.username.eq("member1"))
                            .fetchOne();
    
    boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam());
    // emf.getPersistenceUnitUtil().isLoaded : team ì—”í‹°í‹°ê°€ ë¡œë”©ë˜ì–´ ì´ˆê¸°í™”ê°€ ëœ ìƒíƒœì¸ì§€ ì•„ë‹Œì§€ ì•Œë ¤ì£¼ëŠ” í•¨ìˆ˜.
    assertThat(loaded).as("í˜ì¹˜ ì¡°ì¸ ë¯¸ì ìš©").isFalse();
    // í”„ë¡ì‹œë¡œë§Œ ê°€ì ¸ì˜¨ ìƒíƒœì´ë¯€ë¡œ ë‹¹ì—°íˆ ì´ˆê¸°í™”ëŠ” ì•ˆë˜ì–´ ìˆë‹¤.
}
```

<br>

* í˜ì¹˜ ì¡°ì¸ ì ìš©
    - ì¦‰ì‹œë¡œë”©ìœ¼ë¡œ Member, Team SQL ì¿¼ë¦¬ ì¡°ì¸ìœ¼ë¡œ í•œë²ˆì— ì¡°íšŒ

```java
@Test
public void fetchJoinUse() throws Exception {
    em.flush();
    em.clear();

    Member findMember = queryFactory
            .selectFrom(member)
            .join(member.team, team).fetchJoin()  ğŸ‘ˆ
            .where(member.username.eq("member1"))
            .fetchOne();

    boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam());
    
    assertThat(loaded).as("í˜ì¹˜ ì¡°ì¸ ì ìš©").isTrue();
    // í˜ì¹˜ ì¡°ì¸ì´ë¯€ë¡œ í”„ë¡ì‹œ ê°ì²´ê°€ ì•„ë‹Œ ì‹¤ì œ ì—”í‹°í‹°ë¥¼ ë“¤ê³ ì™€ì„œ ì´ˆê¸°í™” ì‹œì¼°ìœ¼ë¯€ë¡œ true.

}
```


<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ì„œë¸Œì¿¼ë¦¬

<br>

> com.querydsl.jpa.JPAExpressions ì‚¬ìš©

* static import í•´ì„œ ì‚¬ìš©ê°€ëŠ¥.


* ì„œë¸Œì¿¼ë¦¬ - eq ì‚¬ìš©

```java
/**
* ë‚˜ì´ê°€ ê°€ì¥ ë§ì€ íšŒì› ì¡°íšŒ
*/
@Test
public void subQuery() throws Exception {
    // ë³„ì¹­ì´ ì¤‘ë³µë˜ë©´ ì•ˆë˜ë¯€ë¡œ, ë”°ë¡œ ì§€ì •.
    QMember memberSub = new QMember("memberSub");       

    
    List<Member> result = queryFactory
                            .selectFrom(member)
                            .where(member.age.eq(
                                    JPAExpressions  ğŸ‘ˆ
                                            .select(memberSub.age.max())
                                            .from(memberSub)        // ì„œë¸Œì¿¼ë¦¬ -> 40
                                )
                            ) .fetch();
    
    assertThat(result).extracting("age")        // í•„ë“œ êº¼ë‚´ê¸°
                        .containsExactly(40);
}
```


<br>
<br>


* ì„œë¸Œì¿¼ë¦¬ - goe ì‚¬ìš©(ì´ìƒ)

```java
/**
*ë‚˜ì´ê°€ í‰ê·  ë‚˜ì´ ì´ìƒì¸ íšŒì›
*/
@Test
public void subQueryGoe() throws Exception {
    QMember memberSub = new QMember("memberSub");
    List<Member> result = queryFactory
                            .selectFrom(member)
                            .where(member.age.goe(
                                    JPAExpressions
                                            .select(memberSub.age.avg())
                                            .from(memberSub)
                                    )
                                ) .fetch();

    assertThat(result).extracting("age")
            .containsExactly(30,40);
}
```

<br>
<br>

* ì„œë¸Œì¿¼ë¦¬ - ì—¬ëŸ¬ ê±´ ì²˜ë¦¬ in ì‚¬ìš© ğŸ€

```java
**
* ì„œë¸Œì¿¼ë¦¬ ì—¬ëŸ¬ ê±´ ì²˜ë¦¬, in ì‚¬ìš©
*/
@Test
public void subQueryIn() throws Exception {
    QMember memberSub = new QMember("memberSub");

    List<Member> result = queryFactory
                            .selectFrom(member)
                            .where(member.age.in(
                                    JPAExpressions
                                        .select(memberSub.age)
                                        .from(memberSub)
                                        .where(memberSub.age.gt(10))
                                    )
                                ) .fetch();

    assertThat(result).extracting("age")
            .containsExactly(20, 30, 40);
}
```

* ì„œë¸Œì¿¼ë¦¬ - select ì ˆì— subquery

```java
List<Tuple> fetch = queryFactory
          .select(member.username,
                  JPAExpressions
                          .select(memberSub.age.avg())
                          .from(memberSub)
          ).from(member)
          .fetch();

    for (Tuple tuple : fetch) {
        System.out.println("username = " + tuple.get(member.username));
        System.out.println("age = " +
    tuple.get(JPAExpressions.select(memberSub.age.avg()).from(memberSub)));
}
```


* ì„œë¸Œì¿¼ë¦¬ í•œê³„ - from ì ˆì—ì„œ ë¶ˆê°€ëŠ¥
    - JPA JPQL ì„œë¸Œì¿¼ë¦¬ì˜ í•œê³„ì ìœ¼ë¡œ select ë¬¸ê³¼ where ì ˆì—ì„œëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ, from ì ˆì—ì„œëŠ” ì§€ì›Œí•˜ì§€ ì•ŠìŒ. Querydslë„ ë‹¹ì—°íˆ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤.

* from ì ˆì˜ ì„œë¸Œì¿¼ë¦¬ í•´ê²°ë°©ì•ˆ
    - 1. ì„œë¸Œì¿¼ë¦¬ joinìœ¼ë¡œ ë³€ê²½(ë¶ˆê°€ëŠ¥í•œ ê²½ìš°ë„ ìˆìŒ)
    - 2. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¿¼ë¦¬ë¥¼ 2ë²ˆ ë¶„ë¦¬í•´ì„œ ì‹¤í–‰.
    - 3. nativeSQLì„ ì‚¬ìš©.

<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ Case ë¬¸

<br>

> ì™ ë§Œí•˜ë©´ ì‚¬ìš©í•˜ì§€ ë§ì âŒ -> dbì—ì„œ ë°ì´í„°ë¥¼ í¼ì˜¬ë¦¬ëŠ” ì‘ì—…ì€ ì™ ë§Œí•˜ë©´ ìˆëŠ” ê·¸ëŒ€ë¡œë¥¼ ì „ë‹¬í•˜ê³ , ë³€í™˜í•˜ê±°ë‚˜ ë‹¤ë¥¸ê°’ì„ ì¶œë ¥í•˜ëŠ” í–‰ìœ„ NONO! -> ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ì—ì„œ ë°”ê¿”ë¼!!

* select, ì¡°ê±´ì ˆ(where), order by ì—ì„œ ì‚¬ìš©ê°€ëŠ¥.

* ë‹¨ìˆœí•œ ì¡°ê±´
    - when + then

```java
List<String> result = queryFactory
                        .select(member.age
                        .when(10).then("ì—´ì‚´") 
                        .when(20).then("ìŠ¤ë¬´ì‚´") 
                        .otherwise("ê¸°íƒ€"))
                        .from(member)
                        .fetch();

```

* ë³µì¡í•œ ì¡°ê±´
    - CaseBuilder ì‚¬ìš©

```java
List<String> result = queryFactory
                        .select(new CaseBuilder()
                        .when(member.age.between(0, 20)).then("0~20ì‚´") 
                        .when(member.age.between(21, 30)).then("21~30ì‚´") 
                        .otherwise("ê¸°íƒ€"))
                        .from(member)
                        .fetch();
```

<Br>
<Br>
<hr>
<Br>
<Br>


## ğŸŒˆ ìƒìˆ˜, ë¬¸ì ë”í•˜ê¸°

<br>

### ğŸ³ ìƒìˆ˜ ë‚˜íƒ€ë‚´ê¸°

* ìƒìˆ˜ê°€ í•„ìš”í•˜ë©´ Expressions.constant(xxx) ì‚¬ìš©

```java
Tuple result = queryFactory
                    .select(member.username, Expressions.constant("A"))
                    .from(member)
                    .fetchFirst();

/**
ê²°ê³¼
tuple = [member1, A]
tuple = [member2, A]
tuple = [member3, A]
tuple = [member4, A]
 */

```

### ğŸ³ ë¬¸ì ë”í•˜ê¸° concat

* concat ì€ String ë§Œ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ë¬¸ìì—´ì´ ì•„ë‹ˆë¼ë©´, stringValueë¡œ í˜•ë³€í™˜í•´ì„œ ì‚¬ìš©

```java
// ëª©ì  {username}_{age}
String result = queryFactory
                    .select(member.username.concat("_").concat(member.age.stringValue()))
                    .from(member)
                    .where(member.username.eq("member1"))
                    .fetchOne();

/**
ê²°ê³¼
member1_10
 */
```




