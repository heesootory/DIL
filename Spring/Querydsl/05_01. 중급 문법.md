# ì¤‘ê¸‰ ë¬¸ë²•



<br>
<br>
<br>

## ğŸŒˆ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - ê¸°ë³¸

<br>

> í”„ë¡œì ì…˜ ì´ë€?? : select ëŒ€ìƒ ì§€ì •.

* í”„ë¡œì ì…˜ ëŒ€ìƒì´ í•˜ë‚˜ì¼ë•Œ
    - íƒ€ì…ì„ ëª…í™•í•˜ê²Œ ì§€ì •í•  ìˆ˜ ìˆìŒ.
    - ê¸°ë³¸íƒ€ì…(String) ì´ê±°ë‚˜ ì—”í‹°í‹° íƒ€ì… í•˜ë‚˜(member)

* ì˜ˆì‹œì½”ë“œ

```java
// í”„ë¡œì ì…˜ : member.username/ í”„ë¡œì ì…˜ íƒ€ì… : String
List<String> result = queryFactory
          .select(member.username)
          .from(member)
          .fetch();
```

<br>
<br>

* í”„ë¡œì ì…˜ íƒ€ì…ì´ ë‘˜ ì´ìƒ ì¼ë•Œ
    - íŠœí”Œì´ë‚˜ DTO ì‚¬ìš©.
        - íŠœí”Œ : Querydslì´ ì—¬ëŸ¬ê°œ íƒ€ì…ì„ ë°›ì„ ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ ë†“ì€ íƒ€ì….
    - com.querydsl.core.Tuple ì‚¬ìš©.
        - ğŸ€ íŠœí”Œ íƒ€ì…ì€ ë¦¬í¬ì§€í† ë¦¬ ê³„ì¸µ ì•ˆì—ì„œ ì‚¬ìš©í•˜ëŠ” ê±´ ê´œì°®ì¹˜ë§Œ, serviceë‚˜ controllerê¹Œì§€ ë„˜ì–´ê°€ëŠ” ì„¤ê³„ë¥¼ í•˜ëŠ” ê±´ ì¢‹ì§€ ì•Šë‹¤. -> ê·¸ë˜ì•¼ í•˜ë¶€ ê³„ì¸µ(ë¦¬í¬ì§€í† ë¦¬)ë¥¼ ë‹¤ë¥¸ ê¸°ìˆ ë¡œ ë°”ê¾¸ë”ë¼ë„ ë‹¤ë¥¸ ê³„ì¸µì— ì˜í–¥ì„ ì•ˆë¯¸ì¹˜ê²Œ ì„¤ê³„ê°€ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸! ğŸ€ -> ë‚˜ê°ˆ ë•ŒëŠ” DTOë³€í™˜í•´ì„œ ë‚˜ê°€ì.

* ì˜ˆì‹œì½”ë“œ

```java
List<Tuple> result = queryFactory
                        .select(member.username, member.age)
                        .from(member)
                        .fetch();
  
    for (Tuple tuple : result) {
        String username = tuple.get(member.username);
        Integer age = tuple.get(member.age);
        System.out.println("username=" + username);
        System.out.println("age=" + age);
}
```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ í”„ë¡œì ì…˜ê³¼ ê²°ê³¼ ë°˜í™˜ - DTO ì¡°íšŒ

<br>

* DTOë¡œ ì¡°íšŒë¥¼ í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” DTOì— ë§Œë“¤ì–´ ë†“ì€ ìƒì„±ìì— ë§ê²Œ (ë§ˆì¹˜ ì›í•˜ëŠ” í†µì„ ë§Œë“¤ì–´ ë†“ê³  ë‹´ëŠ” ëŠë‚Œ) ê·¸ê²ƒë§Œ ì¡°íšŒí•´ì„œ ì•Œë§ê²Œ í¼ì˜¬ë¦°ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

<br>
<br>


### ğŸ³ ìˆœìˆ˜ JPAì—ì„œ DTO ì¡°íšŒ.

* ìˆœìˆ˜ JPA ì—ì„œëŠ” DTOë¡œ ì¡°íšŒì‹œ, ë§ˆì¹˜ ìƒì„±ìë¥¼ ìƒì„±í•˜ëŠ” ê²ƒ ì²˜ëŸ¼ newëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.

* ë‹¨ì  : DTOì˜ package ì´ë¦„ì„ ë‹¤ ì ì–´ì¤˜ì•¼í•´ì„œ ì§€ì €ë¶„í•¨.

* ìƒì„±ì ë°©ì‹ë§Œ ì§€ì›.

* ì˜ˆì‹œì½”ë“œ
     - DTO
        ```java
        package study.querydsl.dto;

        import lombok.Data;

        @Data
        public class MemberDto {
            private String username;
            private int age;

            public MemberDto() {}

            public MemberDto(String username, int age) {
                this.username = username;
                this.age = age;
            } 
        }
        ```
    - ìˆœìˆ˜ JPA (new operationì„ í™œìš©í•œ ë°©ë²•)
        ```java
        List<MemberDto> result = em.createQuery(
            "select new study.querydsl.dto.MemberDto(m.username, m.age) " +
            "from Member m", MemberDto.class)
            .getResultList();
        ```

<br>
<br>

### ğŸ³ Querydsl ë¹ˆ ìƒì„±(Bean population)

<br>

* 3ê°€ì§€ ë°©ë²•ì„ ì§€ì›.
    - í”„ë¡œí¼í‹° ì ‘ê·¼
    - í•„ë“œ ì§ì ‘ ì ‘ê·¼.
    - ìƒì„±ì ì‚¬ìš©.


* í”„ë¡œí¼í‹° ì ‘ê·¼ - setter ì‚¬ìš©
    - MemberDtoì— í•´ë‹¹ í•„ë“œë³€ìˆ˜ëª…ì˜ setterê°€ ì¡´ì¬í•´ì•¼í•¨.
    - Projections.bean ì‚¬ìš©.
    - MemberDtoì— ê¸°ë³¸ìƒì„±ìê°€ ì¡´ì¬í•´ì•¼ ê°€ëŠ¥!


        ```java
        List<MemberDto> result = queryFactory
                                    .select(Projections.bean(MemberDto.class,
                                            member.username,
                                            member.age))
                                    .from(member)
                                    .fetch();
        ```

* í•„ë“œ ì§ì ‘ ì ‘ê·¼
    - MemberDtoì— setterê°€ ì—†ì–´ë„ í•„ë“œì˜ ë³€ìˆ˜ì— ë°”ë¡œ ê½‚ì•„ë²„ë¦¼.
    - Projections.fields ì‚¬ìš©
        
        ```java
        List<MemberDto> result = queryFactory
                                    .select(Projections.fields(MemberDto.class,
                                            member.username,
                                            member.age))
                                    .from(member)
                                    .fetch();
        ```


* ìƒì„±ì ì‚¬ìš©
     - Projections.fields ì‚¬ìš©.
     - MemberDtoì— ì•Œë§ì€ ìƒì„±ìëŠ” ì¡´ì¬í•´ì•¼ í•¨.
     - ê°€ì ¸ì˜¤ë ¤ëŠ” ë³€ìˆ˜ì™€ MemberDtoì˜ í•„ë“œë³€ìˆ˜ì˜ íƒ€ì…ì´ ì •í™•íˆ ì¼ì¹˜í•˜ë©´ ê°€ëŠ¥.(ë³€ìˆ˜ëª…ì´ ì•ˆë§ì•„ë„ íƒ€ì…ì— ë§¤ì¹˜ë˜ì„œ ë“¤ì–´ê°)
     - ë‹¨ì  : complieì˜¤ë¥˜ê°€ ì•„ë‹Œ runtimeì—ì„œ ì—ëŸ¬ê°€ ë°œê²¬ë˜ê²Œ ëœë‹¤.

        ```java
        List<MemberDto> result = queryFactory
                                    .select(Projections.constructor(MemberDto.class,
                                            member.username,
                                            member.age))
                                    .from(member)
                                    .fetch();
        ```

* ì˜ˆì™¸ìƒí™©
    - ë³„ì¹­ì´ ë‹¤ë¥¼ë•Œ
        - username.as("memberName") : í•„ë“œì— ë³„ì¹­ ì ìš©
    - ì—”í‹°í‹°ì— ì—†ëŠ” ê°’ì„ ë°”ë¡œ DTOë¡œ ì§‘ì–´ ë„£ì–´ì•¼ í• ë•Œ
        - ExpressionUtils.as(source,alias) : í•„ë“œë‚˜, ì„œë¸Œ ì¿¼ë¦¬ì— ë³„ì¹­ ì ìš©
        ```java
        package study.querydsl.dto;
        import lombok.Data;

        @Data
        public class UserDto {
            private String name;
            private int age;
        }

        List<UserDto> fetch = queryFactory
        .select(Projections.fields(UserDto.class,
                member.username.as("name"),  // ë³„ì¹­ì´ ë‹¤ë¥¼ë•Œ
                ExpressionUtils.as(         // ì„œë¸Œì¿¼ë¦¬ë¡œ ê°’ ë§Œë“¤ì–´ì„œ ë„£ê¸°
                        JPAExpressions
                                .select(memberSub.age.max())
                                .from(memberSub), "age")

                )
        ).from(member)
        .fetch();
        ```

<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ í”„ë¡œì íŠ¸ ê²°ê³¼ ë°˜í™˜ - @QueryProjection


<br>

* ì‚¬ìš©ë²•
    - ./gradlew compileQuerydsl
    - QMemberDto ìƒì„± í™•ì¸

    ```java
    // DTO ìƒì„±ìì— ëª…ì‹œ
    package study.querydsl.dto;
    import com.querydsl.core.annotations.QueryProjection;
    import lombok.Data;
    
    @Data
    public class MemberDto {
        private String username;
        private int age;

        public MemberDto() {
        }

        @QueryProjection  âœ”ï¸
        public MemberDto(String username, int age) {
            this.username = username;
            this.age = age;
        }
    }
    ```
    ```java
    // ë¦¬í¬ì§€í† ë¦¬
    List<MemberDto> result = queryFactory
                                .select(new QMemberDto(member.username, member.age))
                                .from(member)
                                .fetch();
    ```

* ì¥ì  
    - runtimeì´ ì•„ë‹Œ compileë‹¨ì—ì„œ ì—ëŸ¬ë¥¼ ì¡ì„ ìˆ˜ ìˆë‹¤. -> ë§¤ìš° ì•ˆì •í•œ ë°©ë²•

* ë‹¨ì 
    - DTOì— QueryDSL ì–´ë…¸í…Œì´ì…˜ì„ ìœ ì§€í•´ì•¼ í•˜ëŠ” ì ê³¼ DTOê¹Œì§€ Q íŒŒì¼ì„ ìƒì„±í•´ì•¼ í•œë‹¤. -> ì•„í‚¤í…ì³ ì ì¸ ë¬¸ì œì—ì„œ DTOê°€ Querydslì— ì˜ì¡´í•˜ê²Œ ë˜ëŠ” ë¬¸ì œì ì´ ìƒê¸´ë‹¤.


<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ë™ì ì¿¼ë¦¬ - BooleanBuilder ì‚¬ìš©

<br>

* ë™ì  ì¿¼ë¦¬ë¥¼ í•´ê²°í•˜ëŠ” ë‘ê°€ì§€ ë°©ì‹  
    - BooleanBuidler
    - Where ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° ì‚¬ìš©.


### ğŸ³ BooleanBuidler

* builderë¥¼ ìƒì„±í•˜ê³ , andë‚˜ orì¡°ê±´ì„ ë¶™ì—¬ì„œ ì¡°ê±´ì„ ìƒì„±í•œë‹¤.

* new BooleanBuilder() ìƒì„±ì‹œ ì´ˆê¸°ê°’ì„ ë„£ì„ ìˆ˜ ìˆë‹¤.

* ì˜ˆì‹œì½”ë“œ
    ```java
    /**
    ë¬¸ì œ : ì´ë¦„ì´ member1ì´ê³ , ë‚˜ì´ê°€ 10ì¸ ì‚¬ëŒì„ ì°¾ê³  ì‹¶ë‹¤.
    ë™ì ì¿¼ë¦¬ : ì´ë¦„ í˜¹ì€ ë‚˜ì´ì¤‘ì— nullì´ ë“¤ì–´ì˜¬ ìˆ˜ ë„ ìˆê¸° ë•Œë¬¸ì— í™•ì¸ì„ í•´ì•¼í•¨.
    */
    @Test
        public void ë™ì ì¿¼ë¦¬_BooleanBuilder() throws Exception {
        String usernameParam = "member1";
        Integer ageParam = 10;
        
        List<Member> result = searchMember1(usernameParam, ageParam);
        
        Assertions.assertThat(result.size()).isEqualTo(1);
    }
    ```

    ```java
    // ë¦¬í¬ì§€í† ë¦¬

    private List<Member> searchMember1(String usernameCond, Integer ageCond) {
        BooleanBuilder builder = new BooleanBuilder();

        if (usernameCond != null) {
            // null ê°’ì´ ì•„ë‹ˆë¼ë©´, usernameCondê³¼ ë™ì¼ì¡°ê±´ ì¶”ê°€
            builder.and(member.username.eq(usernameCond));
        }
        if (ageCond != null) {
            // nullê°’ì´ ì•„ë‹ˆë¼ë©´, ageCondì™€ ë™ì¼ì¡°ê±´ ì¶”ê°€.
            builder.and(member.age.eq(ageCond));
        }

        return queryFactory
                    .selectFrom(member)
                    .where(builder)
                    .fetch();
    }
    // ageParamì´ nullì´ë¼ë©´, usernameCondì—ë§Œ ë“¤ì–´ê°€ê²Œ ëœë‹¤.
    ```

<br>

### ğŸ³ Where ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° ì‚¬ìš©

<br>

* ğŸ€ ê¹€ì˜í•œë‹˜ì´ ì¶”ì²œí•˜ëŠ” booleanBuilderë³´ë‹¤ ê¹”ë”í•œ ë°©ë²•.
    - ë©”ì„œë“œë¥¼ ë§Œë“¤ì–´ì„œ ì§ì ‘ ì»¤ìŠ¤í…€í•˜ëŠ” ë°©ë²•.

* ë©”ì„œë“œë¥¼ ë‹¤ë¥¸ ì¿¼ë¦¬ì—ì„œë„ ì¬í™œìš© ê°€ëŠ¥.

* ì¿¼ë¦¬ ìì²´ì˜ ê°€ë…ì„±ì´ ë†’ì•„ì§„ë‹¤.

* whereë¬¸ì€ nullê°’ì´ ë“¤ì–´ì˜¬ì‹œ, ê·¸ê°’ì€ ë¬´ì‹œë˜ëŠ” íŠ¹ì„±ì„ ì´ìš©.

* ì˜ˆì‹œ ì½”ë“œ
    ```java
    // ê°œë°œì‹œì—ëŠ” ì´ mainì½”ë“œë§Œ ë³´ê³  ì´í•´ ê°€ëŠ¥í•˜ê²Œ ì„¤ê³„.
    private List<Member> searchMember2(String usernameCond, Integer ageCond) {
        return queryFactory
                    .selectFrom(member)
                    .where(usernameEq(usernameCond), ageEq(ageCond))
                    .fetch();
    }

    // custonë©”ì„œë“œ
    private BooleanExpression usernameEq(String usernameCond) {
        return usernameCond != null ? member.username.eq(usernameCond) : null;
    }

    // custonë©”ì„œë“œ
    private BooleanExpression ageEq(Integer ageCond) {
        return ageCond != null ? member.age.eq(ageCond) : null;
    }

    ```
* ì´ ë°©ë²•ì˜ ë˜ ë‹¤ë¥¸ ì¥ì ì€ ì¡°í•©ì´ ê°€ëŠ¥!
    - ì—¬ëŸ¬ ë©”ì„œë“œë¥¼ ì¡°í•©í•˜ëŠ” ë˜ ë‹¤ë¥¸ ë©”ì„œë“œë¡œ ì›í•˜ëŠ” ê¸°ëŠ¥ë³„ë¡œ ì¡°í•©ê°€ëŠ¥

    ```java
    // ê°œë°œì‹œì—ëŠ” ì´ mainì½”ë“œë§Œ ë³´ê³  ì´í•´ ê°€ëŠ¥í•˜ê²Œ ì„¤ê³„.
    private List<Member> searchMember2(String usernameCond, Integer ageCond) {
        return queryFactory
                    .selectFrom(member)
                    .where(allEq(usernameCond, ageCond)) âœ”ï¸
                    .fetch();
    }

    // custonë©”ì„œë“œ
    private BooleanExpression usernameEq(String usernameCond) {
        return usernameCond != null ? member.username.eq(usernameCond) : null;
    }

    // custonë©”ì„œë“œ
    private BooleanExpression ageEq(Integer ageCond) {
        return ageCond != null ? member.age.eq(ageCond) : null;
    }

    // ì¡°í•© custom ë©”ì„œë“œ
    private BooleanExpression allEq(String usernameCond, Integer ageCond) {
        return usernameEq(usernameCond).and(ageEq(ageCond));
    }
    ```

<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ ìˆ˜ì •, ì‚­ì œ ë²Œí¬ ì—°ì‚°

<br>

* ëª¨ë“  ë²Œí¬ ì—°ì‚°ì˜ ì£¼ì˜ì !!!
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ DBì˜ ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤! -> ë²Œí¬ ì—°ì‚° í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”ê°€ í•„ìˆ˜.
        ```java
        em.flush();
        em.clear();
        ```


### ğŸ³ ì¿¼ë¦¬ í•œë²ˆìœ¼ë¡œ ëŒ€ëŸ‰ ë°ì´í„° ìˆ˜ì •

    ```java
    // íšŒì›ì˜ ë‚˜ì´ê°€ 28 ì ë‹¤ë©´, ì´ë¦„ì„ ëª¨ë‘ "ë¹„íšŒì›"ìœ¼ë¡œ ë³€ê²½.
    long count = queryFactory
                    .update(member)
                    .set(member.username, "ë¹„íšŒì›")
                    .where(member.age.lt(28))
                    .execute();
    ```

<br>

### ğŸ³ ê¸°ì¡´ ìˆ«ìì— 1 ë”í•˜ê¸°

* ë¹¼ê¸°ëŠ” add(-1) ì‚¬ìš©

* ê³±í•˜ê¸° multiply(x) ì‚¬ìš©

* ì˜ˆì‹œì½”ë“œ
    ```java
    //ëª¨ë“  íšŒì›ì˜ ë‚˜ì´ + 1
    long count = queryFactory
                    .update(member)
                    .set(member.age, member.age.add(1))
                    .execute();
    ```

<br>

### ğŸ³ ëŒ€ëŸ‰ ì‚­ì œ

    ```java
    long count = queryFactory
                    .delete(member)
                    .where(member.age.gt(18))
                    .execute();
    ```


<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ SQL function í˜¸ì¶œí•˜ê¸°

<br>

> SQL functionì€ JPAì™€ ê°™ì´ Dialectì— ë“±ë¡ëœ ë‚´ìš©ë§Œ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.

* member Mìœ¼ë¡œ ë³€ê²½í•˜ëŠ” replace í•¨ìˆ˜ ì‚¬ìš©
    ```java
    String result = queryFactory
                        .select(Expressions.stringTemplate("function('replace', {0}, {1}, {2})", member.username, "member", "M"))
                        .from(member)
                        .fetchFirst();

    // {0} : member.username
    // {1} : member
    // {2} : M
     ```
<br>

* ì†Œë¬¸ìë¡œ ë³€ê²½í•´ì„œ ë¹„êµ.
    ```java
    .select(member.username)
    .from(member)
    .where(member.username.eq(Expressions.stringTemplate("function('lower', {0})",
    member.username)))
    ```

<br>

* lower ê°™ì€ ansi í‘œì¤€ í•¨ìˆ˜ë“¤ì€ querydslì´ ìƒë‹¹ë¶€ë¶„ ë‚´ì¥ë˜ì–´ ìˆìŒ.

    ```java
    .where(member.username.eq(member.username.lower()))
    ```



