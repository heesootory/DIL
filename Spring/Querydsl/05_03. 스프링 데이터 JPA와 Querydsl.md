# ìŠ¤í”„ë§ ë°ì´í„° JPAdhk Querydsl


<br>

## ğŸŒˆ ìŠ¤í”„ë§ ë°ì´í„° JPA ë¦¬í¬ì§€í† ë¦¬ë¡œ ë³€ê²½

<br>


* ìŠ¤í”„ë§ ë°ì´í„° JPA ìƒì„±    
    - ì¸í„°í˜ì´ìŠ¤ì¸ê±° ì£¼ì˜!!

```java
package study.querydsl.repository;
import org.springframework.data.jpa.repository.JpaRepository;
import study.querydsl.entity.Member;
import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long> {
    List<Member> findByUsername(String username);
}
```

* ìŠ¤í”„ë§ ë°ì´í„° JPA í…ŒìŠ¤íŠ¸

```java
@SpringBootTest
@Transactional
class MemberRepositoryTest {
    @Autowired
    EntityManager em;
    @Autowired
    MemberRepository memberRepository;
    
    @Test
    public void basicTest() {
        Member member = new Member("member1", 10);
        memberRepository.save(member);
        
        Member findMember = memberRepository.findById(member.getId()).get();
        assertThat(findMember).isEqualTo(member);
        
        List<Member> result1 = memberRepository.findAll();
        assertThat(result1).containsExactly(member);
        
        List<Member> result2 = memberRepository.findByUsername("member1");
        assertThat(result2).containsExactly(member);
    }
}
```


<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬

<br>

> ê¸°ì¡´ì˜ ìˆœìˆ˜ JPA ë¦¬í¬ì§€í† ë¦¬ëŠ” class ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë˜ë¯€ë¡œ, Querydslì„ ì£¼ì…ë°›ì•„ì„œ ì›í•˜ëŠ” ë©”ì„œë“œ(ê²€ìƒ‰ì¡°ê±´  ë“±)ë¥¼ ë§Œë“¤ê¸° ìˆ˜ì›”í–ˆì§€ë§Œ, ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•˜ë¯€ë¡œ, ì›í•˜ëŠ” ë©”ì„œë“œë¥¼ ê³§ë°”ë¡œ ë§Œë“¤ ìˆ˜ê°€ ì—†ë‹¤. ë”°ë¼ì„œ ì‚¬ìš©ì ì •ì˜ ë ˆí¬ì§€í† ë¦¬ë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ì„œ ì£¼ì…í•˜ëŠ” ë°©ë²•ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.


* ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ ì‚¬ìš©ë²• (ì•„ë˜ êµ¬ì„± ì‚¬ì§„ê³¼ í•¨ê»˜ ë³´ê¸°)
    - 1. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ì‘ì„±. (MemberRepositoryCustom)
    - 2. ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„. (MemberRepositoryCustomImpl)
    - 3. ìŠ¤í”„ë§ ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬ì— ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ìƒì†. 
        - (MemberRepositoryê°€ JpaRepositoryì™€ MemberRepositoryCustomë¥¼ ìƒì†)

* ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ êµ¬ì„±.

    <img
        src = "../../Image/jpa_00_05/0.png"
        width = 600px
        height = 300px
    />

<br>
<br>

### ğŸ³ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ ë§Œë“œëŠ” ê³¼ì •.

* ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ì‘ì„±
    - ì¸í„°í˜ì´ìŠ¤ëª…ì€ ì•„ë¬´ê±°ë‚˜ ìƒê´€ ì—†ìŒ.
    - ë‚´ê°€ ì»¤ìŠ¤í…€í•´ì„œ ì‚¬ìš©í•  ë©”ì„œë“œë¥¼ ì •ì˜.

```java
package study.querydsl.repository;

import study.querydsl.dto.MemberSearchCondition;
import study.querydsl.dto.MemberTeamDto;
import java.util.List;

public interface MemberRepositoryCustom {
    List<MemberTeamDto> search(MemberSearchCondition condition);
}
```


* ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„.
    - ê·œì¹™: ìœ„ì—ì„œ ë§Œë“  "ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ëª… + Impl"ë¡œ ë§Œë“¤ì–´í•¨.

```java
import static org.springframework.util.StringUtils.isEmpty;
import static study.querydsl.entity.QMember.member;
import static study.querydsl.entity.QTeam.team;

public class MemberRepositoryImpl implements MemberRepositoryCustom {
    private final JPAQueryFactory queryFactory;
    
    public MemberRepositoryImpl(EntityManager em) {
        this.queryFactory = new JPAQueryFactory(em);
    } 

    @Override
    //íšŒì›ëª…, íŒ€ëª…, ë‚˜ì´(ageGoe, ageLoe)
    public List<MemberTeamDto> search(MemberSearchCondition condition) {
    return queryFactory
            .select(new QMemberTeamDto(
                    member.id,
                    member.username,
                    member.age,
                    team.id,
                    team.name))
            .from(member)
            .leftJoin(member.team, team)
            .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe()))
            .fetch();

    private BooleanExpression usernameEq(String username) {
        return isEmpty(username) ? null : member.username.eq(username);
    }
    private BooleanExpression teamNameEq(String teamName) {
        return isEmpty(teamName) ? null : team.name.eq(teamName);
    }
    private BooleanExpression ageGoe(Integer ageGoe) {
        return ageGoe == null ? null : member.age.goe(ageGoe);
    }
    private BooleanExpression ageLoe(Integer ageLoe) {
        return ageLoe == null ? null : member.age.loe(ageLoe);
    }
}

```


* ìŠ¤í”„ë§ ë°ì´í„° ë¦¬í¬ì§€í† ë¦¬ì— ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ìƒì†.
    - ì¸í„°í˜ì´ìŠ¤ëŠ” ì—¬ëŸ¬ê°œì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì† ê°€ëŠ¥.

```java
package study.querydsl.repository;
import org.springframework.data.jpa.repository.JpaRepository;
import study.querydsl.entity.Member;
import java.util.List;

public interface MemberRepository extends JpaRepository<Member, Long>,MemberRepositoryCustom {
    List<Member> findByUsername(String username);
}
```


* ì»¤ìŠ¤í…€ ë¦¬í¬ì§€í† ë¦¬ ë™ì‘ í…ŒìŠ¤íŠ¸

```java
@Test
public void searchTest() {
    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    em.persist(teamA);
    em.persist(teamB);

    Member member1 = new Member("member1", 10, teamA);
    Member member2 = new Member("member2", 20, teamA);
    Member member3 = new Member("member3", 30, teamB);
    Member member4 = new Member("member4", 40, teamB);
    em.persist(member1);
    em.persist(member2);
    em.persist(member3);
    em.persist(member4);

    MemberSearchCondition condition = new MemberSearchCondition();
    
    condition.setAgeGoe(35);
    condition.setAgeLoe(40);
    condition.setTeamName("teamB");

    List<MemberTeamDto> result = memberRepository.search(condition);

    assertThat(result).extracting("username").containsExactly("member4");
}
```

<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš©1 - Querydsl í˜ì´ì§• ì—°ë™.

<br>

* ìŠ¤í”„ë§ ë°ì´í„°ì˜ Page, Pageableì„ í™œìš©í•´ë³´ì.
    - Querydslì—ì„œ ì–´ë–»ê²Œ í™œìš©í• ê¹Œ?

* ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²•.

* ë°ì´í„° ë‚´ìš©ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ë³„ë„ë¡œ ì¡°íšŒí•˜ëŠ” ë°©ë²•.

<br>
<br>

### ğŸ³ ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ì— í˜ì´ì§• 2ê°€ì§€ ì¶”ê°€.

<br>

```java
public interface MemberRepositoryCustom {
    List<MemberTeamDto> search(MemberSearchCondition condition);
    
    Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition,
    Pageable pageable);
    
    Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition,
    Pageable pageable);
}
```


### ğŸ³ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²•

<br>

* searchPageSimple(), fetchResults() ì‚¬ìš©.
    - pageable.getOffset() ì‚¬ìš© : ëª‡ë²ˆì§¸ ë¶€í„° ì‹œì‘í• ì§€
    - pageable.getPageSize() ì‚¬ìš© : ëª‡ê°œì”© ê°€ì ¸ì˜¬ì§€
    - fetchResults() ì‚¬ìš© :
        - fetch()ë¥¼ ì‚¬ìš©í• ì‹œ, ë°˜í™˜íƒ€ì…ì´ Listë¡œ ë‹¨ìˆœíˆ MemberDTOë“¤ë§Œ ì¡°íšŒí•˜ê²Œ ë˜ëŠ”ë°.
        - fetchResults()ë¥¼ ì‚¬ìš©í• ì‹œ, ë°˜í™˜íƒ€ì…ì´ QueryResultsë¡œ ì¹´ìš´íŠ¸ ê°¯ìˆ˜ë„ ì¡°íšŒí•˜ê³ , MemberDTOë“¤ë„ ì¡°íšŒí•˜ê²Œ ë¨.(ì¿¼ë¦¬ê°€ ì‹¤ì œë„ 2ë²ˆ ë‚˜ê°€ê²Œ ë¨.) | ì¹´ìš´íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ì‹œ, í•„ìš”ì—†ëŠ” Order byëŠ” ì œê±°í•¨.

* ë§¤ê°œë³€ìˆ˜
    - condition : ê²€ìƒ‰ ì¡°ê±´ ì„¤ì •.
    - pageable : í˜ì´ì§• ì •ë³´ ì„¤ì •.

```java
/**
* ë‹¨ìˆœí•œ í˜ì´ì§•, fetchResults() ì‚¬ìš©
*/

@Override
public Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition,
Pageable pageable) {
    QueryResults<MemberTeamDto> results = queryFactory
                                            .select(new QMemberTeamDto(
                                                    member.id,
                                                    member.username,
                                                    member.age,
                                                    team.id,
                                                    team.name))
                                            .from(member)
                                            .leftJoin(member.team, team)
                                            .where(
                                                usernameEq(condition.getUsername()),teamNameEq(condition.getTeamName()),
                                                ageGoe(condition.getAgeGoe()),
                                                ageLoe(condition.getAgeLoe()))
                                            .offset(pageable.getOffset())  //ğŸ‘ˆ ëª‡ë²ˆì§¸ ë¶€í„° ì‹œì‘?
                                            .limit(pageable.getPageSize())  //ğŸ‘ˆ ëª‡ê°œì”©?
                                            .fetchResults();
    
    List<MemberTeamDto> content = results.getResults();     // getResults() : ì‹¤ì œ ë°ì´í„°ë¥¼ ë½‘ì•„ë‚´ê¸°
    long total = results.getTotal();                    // getTotal() : ë°ì´í„°ì˜ ê°¯ìˆ˜ ë½‘ì•„ë‚´ê¸°
    return new PageImpl<>(content, pageable, total);
    // ìŠ¤í”„ë§ë°ì´í„°ì˜ Page êµ¬í˜„ì²´ë¥¼ ë°˜í™˜.
```

* test ì½”ë“œ 
    - pageable <= pageRequestë¡œ í˜ì´ì§•í•  ì„¤ì •ì •ë³´ë¥¼ ìƒì„±ë’¤ ì‚¬ìš©.
    - condition <= ì´ì „ì— ë§Œë“¤ì–´ ë†“ì€ MemberSearchCondition (ê²€ìƒ‰ ì¡°ê±´ ì„¤ì •ì •ë³´ëŠ” classë¡œ ë§Œë“¬)ì„ ì‚¬ìš©.

```java
@Test
public void searchTest() {
    Team teamA = new Team("teamA");
    Team teamB = new Team("teamB");
    em.persist(teamA);
    em.persist(teamB);

    Member member1 = new Member("member1", 10, teamA);
    Member member2 = new Member("member2", 20, teamA);
    Member member3 = new Member("member3", 30, teamB);
    Member member4 = new Member("member4", 40, teamB);

    em.persist(member1);
    em.persist(member2);
    em.persist(member3);
    em.persist(member4);

    MemberSearchCondition condition = new MemberSearchCondition();
    PageRequest pageRequest = PageRequest.of(0, 3);
    
    Page<MemberDto> result = memberRepository.searchPageSimple(condition, pageRequest);

    assertThat(result.getSize()).isEqualTo(3);
    assertThat(result.getContent()).extracting("username").containsExactly("member1", "member2", "member3");
}
```

* ë°ì´í„° ë‚´ì˜ê³¼ ì „ì²´ ì¹´ìš´íŠ¸ë¥¼ ë³„ë„ë¡œ ì¡°íšŒí•˜ê¸°
    - fetchCount : ì¹´ìš´íŠ¸ìš© ì¿¼ë¦¬ë§Œ ë°˜í™˜.
    - ì¹´ìš´íŠ¸ìš© ì¿¼ë¦¬ë¥¼ ë”°ë¡œ ë§Œë“œëŠ” ì´ìœ  
        - leftjoinê°™ì€ê²Œ í•„ìš”ì—†ëŠ” ê²½ìš°ê°€ ìˆë‹¤. ê·¸ëŸ°ê²½ìš°ì— ìµœì í™”ë¥¼ ìœ„í•´, ì¹´ìš´íŠ¸ ì¿¼ë¦¬ëŠ” íš¨ìœ¨ì ìœ¼ë¡œ ì§œëŠ”ê²Œ ì¢‹ë‹¤.


```java
**
* ë³µì¡í•œ í˜ì´ì§•
* ë°ì´í„° ì¡°íšŒ ì¿¼ë¦¬ì™€, ì „ì²´ ì¹´ìš´íŠ¸ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬ */
@Override
public Page<MemberTeamDto> searchPageComplex(MemberSearchCondition condition,
Pageable pageable) {
    List<MemberTeamDto> content = queryFactory
                                    .select(new QMemberTeamDto(
                                            member.id,
                                            member.username,
                                            member.age,
                                            team.id,
                                            team.name))
                                    .from(member)
                                    .leftJoin(member.team, team)
                                    .where(
                                        usernameEq(condition.getUsername()),
                                        teamNameEq(condition.getTeamName()),
                                        ageGoe(condition.getAgeGoe()),
                                        ageLoe(condition.getAgeLoe()))
                                    .offset(pageable.getOffset())
                                    .limit(pageable.getPageSize())
                                    .fetch();

    // ì¹´ìš´íŠ¸ìš© ì¿¼ë¦¬ë¥¼ ë”°ë¡œ ë§Œë“¬.
    long total = queryFactory
                .select(member)
                .from(member)
                .leftJoin(member.team, team)
                .where(
                    usernameEq(condition.getUsername()),
                    teamNameEq(condition.getTeamName()),
                    ageGoe(condition.getAgeGoe()),
                    ageLoe(condition.getAgeLoe()))
                .fetchCount();

    return new PageImpl<>(content, pageable, total);
}
```


<br>
<br>


### ğŸ³ ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš©2 - CountQuery ìµœì í™”


* count ì¿¼ë¦¬ê°€ ìƒëµ ê°€ëŠ¥í•œ ê²½ìš° ìƒëµí•´ì„œ ì²˜ë¦¬
    - í˜ì´ì§€ ì‹œì‘ì´ë©´ì„œ ì»¨í…ì¸  ì‚¬ì´ì¦ˆê°€ í˜ì´ì§€ ì‚¬ì´ì¦ˆë³´ë‹¤ ì‘ì„ë•Œ.
    - ë§ˆì§€ë§‰ í˜ì´ì§€ ì¼ë•Œ (offset + ì»¨í…ì¸  ì‚¬ì´ì¦ˆë¥¼ ë”í•´ì„œ ì „ì²´ ì‚¬ì´ì¦ˆ êµ¬í•¨)


<br>
<br>


### ğŸ³ ìŠ¤í”„ë§ ë°ì´í„° í˜ì´ì§• í™œìš©3 - ì»¨íŠ¸ë¡¤ëŸ¬ ê°œë°œ

* ì»¨íŠ¸ë¡¤ëŸ¬

```java
@RestController
@RequiredArgsConstructor
public class MemberController {
    
    private final MemberJpaRepository memberJpaRepository;
    private final MemberRepository memberRepository;
    
    @GetMapping("/v1/members")
    public List<MemberTeamDto> searchMemberV1(MemberSearchCondition condition){
        return memberJpaRepository.search(condition);
    }

    @GetMapping("/v2/members")
    public Page<MemberTeamDto> searchMemberV2(MemberSearchCondition condition, Pageable pageable) {
        return memberRepository.searchPageSimple(condition, pageable);
    }

    @GetMapping("/v3/members")
    public Page<MemberTeamDto> searchMemberV3(MemberSearchCondition condition, Pageable pageable) {
        return memberRepository.searchPageComplex(condition, pageable);
    }
}
```


* ìš”ì²­
    - http://localhost:8080/v2/members?size=5&page=2
















