# í™•ì¥ ê¸°ëŠ¥



<br>
<br>
<br>


## ğŸŒˆ ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„

* ìŠ¤í”„ë§ ë°ì´í„° JPA ë¦¬í¬ì§€í† ë¦¬ëŠ” ì¸í„°í˜ì´ìŠ¤ë§Œ ì •ì˜í•˜ê³  êµ¬í˜„ì œëŠ” ìŠ¤í”„ë§ì´ ìë™ ìƒì„±.

* ìŠ¤í”„ë§ ë°ì´í„° JPAê°€ ì œê³µí•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì§ì ‘ êµ¬í˜„í•˜ë©´ êµ¬í˜„í•´ì•¼ í•˜ëŠ” ê¸°ëŠ¥ì´ ë„ˆë¬´ ë§ìŒ

* ë”°ë¼ì„œ, ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ê³  ì‹¶ë‹¤ë©´??
    - JPA ì§ì ‘ ì‚¬ìš©(EntityManager)
    - ìŠ¤í”„ë§ JDBC Template
    - MyBatis
    - ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ ì§ì ‘ ì‚¬ìš© ë“±..
    - Querydsl ì‚¬ìš© ğŸ€

* ğŸ€ ìŠ¤í”„ë§ ë°ì´í„° JPAë¡œ í•´ê²°ì´ ì•ˆë˜ëŠ” ê²½ìš°, ë³µì¡í•œ ì¿¼ë¦¬ê°€ í•„ìš”í•  ë•Œ, ë³´í†µ Querydslë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œ ë§Œë“¤ê²Œ ëœë‹¤.

* cf. í•­ìƒ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ê°€ í•„ìš”í•œ ê²ƒì´ ì•„ë‹ˆë‹¤! ì¤‘ìš”í•œ ê±´ ë³µì¡í•œ ì¿¼ë¦¬ë¬¸ì— ëŒ€í•œ í•´ê²°ì±…ìœ¼ë¡œ ë¬´ì¡°ê±´ì ìœ¼ë¡œ ë¬´ë¶„ë³„í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ì˜¤íˆë ¤ í˜ë“¤ì–´ì§€ëŠ” ì§€ë¦„ê¸¸! customì—ë‹¤ê°€ ëª¨ë“  ë¡œì§ì„ êµ¬í˜„í•˜ì§€ ë§ˆë¼!
    - ê¼­ ì‚¬ìš©ì ì •ì˜ ë¦¬í¬ì§€í† ë¦¬ë¥¼ êµ¬í˜„í•˜ì§€ ì•Šê³ , ì´ˆë°˜ì— í–ˆë˜ ìˆœìˆ˜ JPA ë¦¬í¬ì§€í† ë¦¬ ì²˜ëŸ¼ @Repositoryê°€ ë¶™ì€ ë¦¬í¬ì§€í† ë¦¬ë¡œ ë¶„ë¦¬í•´ë„ ëœë‹¤!!

> ğŸ€ ê¹€ì˜í•œë‹˜ì˜ íŒ! ğŸ€ <br>
> í•µì‹¬ ë¹„ì§€ë‹ˆìŠ¤ì— ê´€ë ¨ëœ ë¦¬í¬ì§€í† ë¦¬ì™€ ë‹¨ìˆœ í™”ë©´ì— ë§ì¶˜ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì•„ì˜ˆ ë¶„ë¦¬í•´ì„œ ì‘ì—…í•œë‹¤.
> ì¿¼ë¦¬ì™€ ì»¤ë§¨ë“œë¥¼ ë‚˜ëˆ„ì–´ì„œ ì •ë¦¬ í–ˆë˜ ê²ƒ ì²˜ëŸ¼, í•µì‹¬ ë¹„ì§€ë‹ˆìŠ¤ì™€ ë‹¨ìˆœ í™”ë©´ ì¡°íšŒë¥¼ ìœ„í•œ ë¡œì§ì„ ë‚˜ëˆ ì„œ ìƒê°í•˜ê³  ë¦¬í¬ì§€í† ë¦¬ë¥¼ êµ¬ì„±í•œë‹¤ë©´, ìœ ì§€ë³´ìˆ˜ê°€ í›¨ì”¬ ìˆ˜ì›”í•˜ë‹¤.

* ì‚¬ìš©ë°©ë²•

    - ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤
    ```java
    public interface MemberRepositoryCustom {
      List<Member> findMemberCustom();
    }
    ```

    - ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ í´ë˜ìŠ¤ : ìˆœìˆ˜ JPQL ì‚¬ìš©ì‹œ.
        - ğŸ€ "ë©”ì¸ ì¸í„°í˜ì´ìŠ¤"(MemberRepository) ì—ì„œ "Impl"ë¥¼ ë¶™íŒ ì´ë¦„ ê·œì¹™ì„ ì‚¬ìš©í•´ì•¼ í•¨.

    ```java
    @RequiredArgsConstructor
    public class MemberRepositoryImpl implements MemberRepositoryCustom {
        private final EntityManager em;
        
        @Override
        public List<Member> findMemberCustom() {
            return em.createQuery("select m from Member m")
                    .getResultList();
        } 
    }
    ```

    - JpaRepositoryë¥¼ ìƒì† ë°›ê³  ìˆëŠ” "ë©”ì¸ ì¸í„°í˜ì´ìŠ¤"(MemberRepository) ì—ê²Œ customí•œ ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ë„ ìƒì† ì‹œí‚¤ê¸°.
    ```java
    public interface MemberRepository
           extends JpaRepository<Member, Long>, MemberRepositoryCustom {
    }
    ``` 

    - ì‚¬ìš©ì ì •ì˜ ë©”ì„œë“œ í˜¸ì¶œ
    ```java
    List<Member> result = memberRepository.findMemberCustom();
    ```

* Impl ë¶™íˆëŠ” ì´ë¦„ì„ ëŒ€ì‹  ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´?
    - but, ë  ìˆ˜ ìˆìœ¼ë©´ ê·¸ëƒ¥ ê´€ë¡€ë¥¼ ë”°ë¥´ì...ìœ ì§€ë³´ìˆ˜í•˜ê¸° í˜ë“¤ì–´ì§...ã… ã… 

    - XML ì„¤ì •
    ```java
    <repositories base-package="study.datajpa.repository" repository-impl-postfix="Impl" />
    ```

    - JavaConfig ì„¤ì •
    ```java
    @EnableJpaRepositories(basePackages = "study.datajpa.repository",
                           repositoryImplementationPostfix = "Impl")

    ```


* ìµœì‹  ìŠ¤í”„ë§ ë°ì´í„° 2.x ì—ì„œ ë³€ê²½ëœ ë‚´ìš©.
    - ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ëª… + "Impl" ë°©ì‹ë„ ì§€ì›. ìœ„ì˜ ì˜ˆì œì—ì„œ "MemberRepositoryCustomImpl" ì´ë¦„ìœ¼ë¡œ êµ¬í˜„ë„ ê°€ëŠ¥!!

    - ê¸°ì¡´ì˜ ë°©ì‹ë³´ë‹¤ ì´ ë°©ì‹ì´ ì‚¬ìš©ì ì •ì˜ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ê³¼ êµ¬í˜„ í´ë˜ìŠ¤ ì´ë¦„ì´ ë¹„ìŠ·í•˜ë¯€ë¡œ ë” ì§ê´€ì .

    - ì˜ˆì‹œ ì½”ë“œ
    ```java
    @RequiredArgsConstructor
    public class MemberRepositoryCustomImpl implements MemberRepositoryCustom {
        private final EntityManager em;
        @Override
        public List<Member> findMemberCustom() {
            return em.createQuery("select m from Member m")
                    .getResultList();
        }
    }
    ```

<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ Auditing

> ì—”í‹°í‹°ë¥¼ ìƒì„±, ë³€ê²½í•  ë•Œ ë³€ê²½í•œ ì‚¬ëŒê³¼ ì‹œê°„ì„ ì¶”ì í•˜ê¸° ìœ„í•´ ì‚¬ìš©.

> ìš´ì˜ ë‹¨ê³„ì—ì„œ ì–´ë””ì„œ ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ ì•Œì•„ì•¼ ìœ ì§€ë³´ìˆ˜ê°€ ê°€ëŠ¥í•˜ë¯€ë¡œ í•„ìˆ˜ì ì¸ ê¸°ëŠ¥ì´ë‹¤.


### ğŸ³ ìˆœìˆ˜ JPA ì‚¬ìš©

* ì‹¤ì œ ì‚¬ìš© ì—”í‹°í‹°ì— ìƒì†ì‹œí‚¬ ë“±ë¡ì¼, ìˆ˜ì •ì¼ ì—”í‹°í‹°.
    - @MappedSuperclass : ì‹¤ì œ ìƒì†ê³¼ ë‹¬ë¦¬ JPAê°„ì˜ ìƒì†. ë‹¨ìˆœíˆ ë¶€ëª¨ì˜ ì†ì„±(ë³€ìˆ˜)ë“¤ë§Œ ìì‹ í´ë˜ìŠ¤ì— ê³µìœ í•  ìˆ˜ ìˆê²Œí•¨.(ì´ ì–´ë…¸í…Œì´ì…˜ì´ ì—†ìœ¼ë©´, createdDate, updatedDate ì†ì„±ì´ Memberí´ë˜ìŠ¤ ìƒì„±ì‹œì— ì•ˆë§Œë“¤ì–´ì§.)
    - @PrePersist : ì˜ì† í•˜ê¸° ì§ì „. (@PostPersist)
    - @PreUpdate : ìˆ˜ì • ë˜ê¸° ì§ì „. (@PostUpdate)
    - @Column(updatable = false) : í•œë²ˆ ë“±ë¡ì´ ë˜ë©´ ìˆ˜ì •ì´ ë¶ˆê°€í•˜ë„ë¡ ì„¤ì •.

```java
@MappedSuperclass
@Getter
public class JpaBaseEntity {

    @Column(updatable = false)
    private LocalDateTime createdDate;
    private LocalDateTime updatedDate;

    @PrePersist
    public void prePersist() {
        LocalDateTime now = LocalDateTime.now();
        createdDate = now;
        updatedDate = now;
    }

    @PreUpdate
    public void preUpdate() {
        updatedDate = LocalDateTime.now();
    }
}
 
```

* ì‹¤ì œ ì‚¬ìš© ì—”í‹°í‹° Member

```java
public class Member extends JpaBaseEntity {}
```


<br>
<br>
<br>

### ğŸ³ ìŠ¤í”„ë§ ë°ì´í„° JPA ì‚¬ìš©

* ì„¤ì •
    - @EnableJpaAuditing : ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë“±ë¡.
    ```java
    @EnableJpaAuditing ğŸ‘ˆ
    @SpringBootApplication
    public class DataJpaApplication {
        public static void main(String[] argd){
            SpringApplication.run(DataJpaApplication.class, args);
        }
    }
    ```

* ì‚¬ìš© ì–´ë…¸í…Œì´ì…˜
    - @EntityListeners(AuditingEntityListener.class) : ì—”í‹°í‹°ê°€ ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ê°ì§€í•´ì„œ ë™ì‘í•˜ëŠ” ê¸°ëŠ¥ì´ ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜
    - @CreatedDate
    - @LastModifiedDate
    - @CreatedBy
    - @LastModifiedBy


* ìŠ¤í”„ë§ ë°ì´í„° Auditing ì ìš© - ë“±ë¡ì¼, ìˆ˜ì •ì¼
    ```java
    package study.datajpa.entity;


    @EntityListeners(AuditingEntityListener.class)
    @MappedSuperclass
    @Getter
    public class BaseEntity {
        
        // ë“±ë¡ì¼
        @CreatedDate
        @Column(updatable = false)
        private LocalDateTime createdDate;

        // ìˆ˜ì •ì¼
        @LastModifiedDate
        private LocalDateTime lastModifiedDate;
    }
    ```

* ìŠ¤í”„ë§ ë°ì´í„° Auditing ì ìš© - ë“±ë¡ì, ìˆ˜ì •ì
    - AuditorAware : ì‹¤ë¬´ì—ì„œëŠ” ì„¸ì…˜ ì •ë³´ë‚˜, ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ë¡œê·¸ì¸ ì •ë³´ì—ì„œ IDë¥¼ ë°›ìŒ
    - auditorProvider : ë“±ë¡ì´ë‚˜ ìˆ˜ì •ì´ ì¼ì–´ë‚  ë•Œë§ˆë‹¤ auditorProviderì„ í˜¸ì¶œí•˜ê³ , í•´ë‹¹ IDë¥¼ ì €ì¥.

    ```java
    @EnableJpaAuditing 
    @SpringBootApplication
    public class DataJpaApplication {
        public static void main(String[] argd){
            SpringApplication.run(DataJpaApplication.class, args);
        }

        // ğŸ€ ë“±ë¡ì, ìˆ˜ì •ìë¥¼ ì²˜ë¦¬í•´ì£¼ëŠ” AuditorAware ìŠ¤í”„ë§ ë¹ˆ ë“±ë¡.
        @Bean
        public AuditorAware<String> auditorProvider() {
            return () -> Optional.of(UUID.randomUUID().toString());
        }

    }
    ```
    ```java
    package study.datajpa.entity;


    @EntityListeners(AuditingEntityListener.class)
    @MappedSuperclass
    @Getter
    public class BaseEntity {
        
        // ë“±ë¡ì¼
        @CreatedDate
        @Column(updatable = false)
        private LocalDateTime createdDate;

        // ìˆ˜ì •ì¼
        @LastModifiedDate
        private LocalDateTime lastModifiedDate;

        // ë“±ë¡ì
        @CreatedBy
        @Column(updatable = false)
        private String createdBy;
        
        // ìˆ˜ì •ì
        @LastModifiedBy
        private String lastModifiedBy;
    }
    ```

* ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°€ì¥ ìœ ìš©í•œ ë°©ë²•
    - ëŒ€ë¶€ë¶„ì˜ ì—”í‹°í‹°ì—ì„œ ë“±ë¡ì‹œê°„, ìˆ˜ì • ì‹œê°„ì€ í•„ìš”í•˜ì§€ë§Œ ë“±ë¡ìì™€ ìˆ˜ì •ìê¹Œì§€ëŠ” í•„ìš”ê°€ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ, Baseíƒ€ì…ì„ ë¶„ë¦¬í•˜ê³ , í•„ìš”í•œ ì—”í‹°í‹°ì—ì„œ ì•Œë§ê²Œ ìƒì† ë°›ì•„ ì‚¬ìš©í•œë‹¤.

    ```java
    // ë“±ë¡ì‹œê°„, ìˆ˜ì •ì‹œê°„ë§Œ í•„ìš”ì‹œ 
    public class BaseTimeEntity {
        
        @CreatedDate
        @Column(updatable = false)
        private LocalDateTime createdDate;
        
        @LastModifiedDate
        private LocalDateTime lastModifiedDate;
    }

    // ì „ë¶€ í•„ìš”ì‹œ
    public class BaseEntity extends BaseTimeEntity {
        @CreatedBy
        @Column(updatable = false)
        private String createdBy;
        
        @LastModifiedBy
        private String lastModifiedBy;
    }
    ```


<br>
<br>
<hr>
<br>
<br>


## ğŸŒˆ Web í™•ì¥ - í˜ì´ì§•ê³¼ ì •ë ¬

> ìŠ¤í”„ë§ ë°ì´í„°ê°€ ì œê³µí•˜ëŠ” í˜ì´ì§•ê³¼ ì •ë ¬ ê¸°ëŠ¥ì„ ìŠ¤í”„ë§ MVCì—ì„œ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

* í˜ì´ì§•ê³¼ ì •ë ¬ ì˜ˆì œ ì½”ë“œ
    - íŒŒë¼ë¯¸í„°ë¡œ Pagableì„ ë°›ì„ ìˆ˜ ìˆë‹¤.
    - Pageable ì€ ì¸í„°í˜ì´ìŠ¤, ì‹¤ì œëŠ” org.springframework.data.domain.PageRequest ê°ì²´ ìƒì„±.

```java
@GetMapping("/members")
public Page<Member> list(Pageable pageable) {
    Page<Member> page = memberRepository.findAll(pageable);
    return page;
}
```

* ìš”ì²­ íŒŒë¼ë¯¸í„°
    - ì˜ˆ) /members?page=0&size=3&sort=id,desc&sort=username,desc
    - page: í˜„ì¬ í˜ì´ì§€, 0ë¶€í„° ì‹œì‘.
    - size: í•œ í˜ì´ì§€ì— ë…¸ì¶œí•  ë°ì´í„° ìˆ˜. (ê¸°ë³¸ê°’ : 20ê°œ)
    - sort : ì •ë ¬ ì¡°ê±´ì„ ì •ì˜.

* ê¸°ë³¸ê°’ ì„¤ì •
    - ê¸€ë¡œë²Œ ì„¤ì • : ìŠ¤í”„ë§ ë¶€íŠ¸
        ```java
        spring.data.web.pageable.default-page-size=20 /# ê¸°ë³¸ í˜ì´ì§€ ì‚¬ì´ì¦ˆ/ spring.data.web.pageable.max-page-size=2000 /# ìµœëŒ€ í˜ì´ì§€ ì‚¬ì´ì¦ˆ/
        ```
    - ê°œë³„ ì„¤ì •
        - @PageableDefault ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©.(ê¸€ë¡œë²Œ ì„¤ì •ë³´ë‹¤ ìš°ì„ ì´ ë¨.)
        ```java
        @RequestMapping(value = "/members_page", method = RequestMethod.GET)
            public String list(@PageableDefault(size = 12, sort = â€œusernameâ€,       
            direction = Sort.Direction.DESC) Pageable pageable) {
            ... }
            
        ```

* ì ‘ë‘ì‚¬
    - í˜ì´ì§• ì •ë³´ê°€ ë‘˜ ì´ìƒì´ë©´ ì ‘ë‘ì‚¬ë¡œ êµ¬ë¶„. -> ë‘ ê°€ì§€ ë¶„ë¥˜ë¡œ í˜ì´ì§•ì„ í•´ì•¼ í• ë•Œ
    - @Qualifier ì— ì ‘ë‘ì‚¬ëª… ì¶”ê°€ "{ì ‘ë‘ì‚¬ëª…}_xxxâ€
    - ìš”ì²­ ì˜ˆì œ: /members?member_page=0&order_page=1
    ```java
    public String list(
        @Qualifier("member") Pageable memberPageable,
        @Qualifier("order") Pageable orderPageable, ..
    ```
    

* Page ë‚´ìš©ì„ DTOë¡œ ë³€í™˜.

    - ìœ„ì™€ ê°™ì€ ì˜ˆì‹œë“¤ì€ ì‚¬ìš©ì˜ˆì‹œì´ì§€ë§Œ, ì‚¬ì‹¤ ì—”í‹°í‹°ë¥¼ ìœ„ì™€ê°™ì´ ë…¸ì¶œí•´ì„œëŠ” ì•ˆëœë‹¤.

    - Page.map() ì‚¬ìš©
        ```java
        Page<MemberDto> map = page.map(member -> new MemberDto(member.getId(), member.getUsername(), member.getTeam().getName()));  ğŸ‘ˆ 
        ```
    - DTO ëŠ” ì—”í‹°í‹°ë¥¼ ë´ë„ ê´œì°®. -> ì˜ì¡´ê´€ê³„ê°€ ì—”í‹°í‹°ëŠ” DTOë¥¼ ë³´ë©´ ì•ˆë˜ì§€ë§Œ, ì—­ì€ ê´œì°®!
        ```java
        // MemberDTO
        @Data
        public class MemberDto {
            private Long id;
            private String username;
            // ì—”í‹°í‹°ì— ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ë°›ì•„ì˜¤ëŠ” ìƒì„±ì. ğŸ‘ˆ
            public MemberDto(Member m) {
                this.id = m.getId();
                this.username = m.getUsername();
            }
        }
        ```

        ```java
        @GetMapping("/members")
            public Page<MemberDto> list(Pageable pageable) {
                Page<Member> page = memberRepository.findAll(pageable);
                // DTOê°€ ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë°›ìœ¼ë©´, ì•„ë˜ì™€ ê°™ì´ mapí•¨ìˆ˜ í™œìš©ì´ ê°€ëŠ¥.
                Page<MemberDto> pageDto = page.map(MemberDto::new);  ğŸ‘ˆ (java 8 ë¬¸ë²•)
                return pageDto;
        }

        ```

    - Page.map() ì½”ë“œ ìµœì í™”
        ```java
        @GetMapping("/members")
        public Page<MemberDto> list(Pageable pageable) {
            return memberRepository.findAll(pageable).map(MemberDto::new);
        }
        ```


<br>


