# ì¿¼ë¦¬ ë©”ì„œë“œ ê¸°ëŠ¥


<br>
<br>
<br>

## ğŸŒˆ ì¿¼ë¦¬ ë©”ì„œë“œ ê¸°ëŠ¥ 3ê°€ì§€

* ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±. ğŸ€

* ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ(ìì£¼ ì‚¬ìš©âŒ).

* @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ ë ˆí¼ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜. ğŸ€


<br>
<br>

## ğŸŒˆ 1. ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±


<br>
<br>

> ë©”ì„œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQL ì¿¼ë¦¬ ì‹¤í–‰.

* ì˜ˆì‹œ
    ```java
    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);
    // Username ê¸°ë°˜ìœ¼ë¡œ ì¼ì¹˜ + Ageê°€ ageë³´ë‹¤ í° row ì¡°íšŒ
    ```


* ì¿¼ë¦¬ ë©”ì†Œë“œ í•„í„° ì¡°ê±´ 
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation)

* ì¡°íšŒ : find...By, read...By, query...By, get...By
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation)
    - By ëŠ” ë’¤ì— ì¡°ê±´ì´ ë” ë¶™ëŠ” ë‹¤ëŠ” ì˜ë¯¸ë¡œ, Byë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤ë©´ ì „ì²´ ì¡°íšŒí•œë‹¤.
    - ... ë¶€ë¶„ì€ ì•„ë¬´ ì´ë¦„ì´ë‚˜ ë„£ì–´ë„ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œë‹¤.

* COUNT : count...By /  ë°˜í™˜íƒ€ì… : long
* EXISTS : exists...By / ë°˜í™˜íƒ€ì… : boolean
* ì‚­ì œ : delete...By, remove...By / ë°˜í™˜íƒ€ì… : long
* DISTINCT : findDistinct, findMemberDistinctBy
    ```java
    List<Person> findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
    List<Person> findPeopleDistinctByLastnameOrFirstname(String lastname, String firstname);
    // DISTINCT ëŠ” í•´ë‹¹ column ì•,ë’¤ ë¬´ê´€.
    ```
* LIMIT : findFirst3, findFirst, findTop, findTop3
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result)


> ì°¸ê³  : ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©°ë„ˆ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼í•¨. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ ë°œìƒ.<br>
ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì . ğŸ€

> ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì˜¤íˆë ¤ ë³µì¡í•´ì§ˆìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ì˜ ì¡°ê±´ì´ ë§ì•„ì§ˆ ê²½ìš°ì—ëŠ” 3ë²ˆ ê¸°ëŠ¥ì¸ JPQLë¥¼ ì§ì ‘ ì§œëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì.

<br>
<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ 3. @Query, ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°

<br>
<br>

> ì‹¤ë¬´ì—ì„œëŠ” ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ @Query ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œë¨.

* @org.springframework.data.jpa.repository.Query ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©.

* ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ <mark>ì´ë¦„ ì—†ëŠ” Named ì¿¼ë¦¬</mark>ë¼ í•  ìˆ˜ ìˆìŒ

* JPA Named ì¿¼ë¦¬ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆìŒ(ë§¤ìš° í° ì¥ì !)ğŸ€

```java
@Query("select m from Member m where m.username = :username and m.age = :age")
List<Member> findUser(@Param("username") String username, @Param("age") int
age);
```

<br>
<br>


### ğŸ³ @Query, ê°’, DTO ì¡°íšŒí•˜ê¸°

<br>

> ì—¬íƒœê¹Œì§€ëŠ” ëª¨ë‘ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ê°€ì ¸ì™”ëŠ”ë°, ë‹¨ìˆœíˆ ê°’ì´ë‚˜ DTOë¥¼ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•.

#### ğŸ¯ ê¸°ë³¸ ê°’ íƒ€ì…

<br>

```java
@Query("select m.username from Member m")
List<String> findUsernameList();
```

* ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì€ Member ê°™ì€ ì—”í‹°í‹° íƒ€ì…ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í–ˆì§€ë§Œ, ìœ„ì™€ ê°™ì´ String íƒ€ì…ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ìœ¼ë©´, usernameì˜ ì´ë¦„ ì „ë¶€ë¥¼ ë‹¨ìˆœíˆ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.

* JPA ê°’ íƒ€ì…(@Embedded)ë„ ì´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥.

<br>
<br>

#### ğŸ¯ DTO íƒ€ì…

<br>

```java
// DTO ìƒì„±

@Data
  public class MemberDto {
      private Long id;
      private String username;
      private String teamName;

      public MemberDto(Long id, String username, String teamName) {
          this.id = id;
          this.username = username;
          this.teamName = teamName;
      }
}
```
```java
// Repository

@Query("select new study.datajpa.dto.MemberDto(m.id, m.username, t.name) " +
          "from Member m join m.team t")
List<MemberDto> findMemberDto();
```

* DTOë¡œ ì§ì ‘ ì¡°íšŒ í•˜ë ¤ë©´ new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©.
    - new study.datajpa.dto.MemberDto(m.id, m.username, t.name) ëŠ” ì‹¤ì œë¡œ DTOí´ë˜ìŠ¤ì˜ ìƒì„±ìì— í•´ë‹¹í•œë‹¤. ë”°ë¼ì„œ ìƒì„±ìê°€ ì¡´ì¬í•´ì•¼í•¨.

<br>
<br>
<br>

### ğŸ³ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

<br>


* ìœ„ì¹˜ ê¸°ë°˜ -> ì‚¬ìš© âŒ
* ì´ë¦„ ê¸°ë°˜ 

```java
 select m from Member m where m.username = ?0 //ìœ„ì¹˜ ê¸°ë°˜ 
 select m from Member m where m.username = :name //ì´ë¦„ ê¸°ë°˜
````

> ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ <mark>ì´ë¦„ ê¸°ë°˜</mark>íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ì!!!

```java
@Query("select m from Member m where m.username = :name")
Member findMembers(@Param("name") String username);
```


#### ğŸ¯ ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

* Collection íƒ€ì…ìœ¼ë¡œ in ì ˆ ì§€ì›.
    - inì ˆ ë’¤ì—ì˜¤ëŠ” ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ì´ë¦„ë“¤ì„ í¬í•¨í•˜ëŠ” ê²ƒì„ ì¡°íšŒ ê°€ëŠ¥.

```java
@Query("select m from Member m where m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```


<br>
<br>
<br>

### ğŸ³ ë°˜í™˜ íƒ€ì…

<br>

> ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì…ì„ ì§€ì›. [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-return-types)

```java
List<Member> findByUsername(String name); //ì»¬ë ‰ì…˜ 
Member findByUsername(String name); //ë‹¨ê±´
Optional<Member> findByUsername(String name); //ë‹¨ê±´ Optional
```

* í•¨ìˆ˜ëª…ì— ë°˜í™˜íƒ€ì…ì„ ì ëŠ”ê²ƒì€ ì•ˆì ì–´ë„ ë˜ê³ , ë§¤ìš° ìœ ì—°í•˜ê²Œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì•„ë¬´ ëª…ì‚¬ë¡œ ì ì–´ë„ë¨.
    - ìœ„ì˜ í•¨ìˆ˜ëª…ë“¤ì„ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½í•´ë„ ë¬´ê´€.
        - findListByUsername
        - findMemberByUsername
        - findOptionalByUsername


#### ğŸ¯ ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì ì„ë•Œ!!

* ì»¬ë ‰ì…˜
    - ê²°ê³¼ ì—†ìŒ : ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜ -> ì „í˜€ ë¬¸ì œê°€ ë˜ì§€ ì•ŠìŒ.

* ë‹¨ê±´ ì¡°íšŒ
    - ê²°ê³¼ ì—†ìŒ : nullë°˜í™˜ -> ê²°ê³¼ê°€ ìˆê±°ë‚˜ ì—†ê±°ë‚˜ì˜ ë¬¸ì œë©´ Optional ë‹¨ê±´ì¡°íšŒë¥¼ ì‚¬ìš©í•˜ì.
    ```java
    Optional<Member> findMember = memberRepository.findOptionalByUsername("heesoo");
    // ìë°”8 ë¬¸ë²•ì„ ì ê·¹ í™œìš©í•˜ì.
    ```
    - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ : javax.persistence.NonUniqueResultException ì˜ˆì™¸ ë°œìƒ

    
<br>
<br>
<br>


### ğŸ³ í˜ì´ì§•ê³¼ ì •ë ¬

<br>
<br>
<br>

#### ğŸ‹ ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬

<br>

* JPQL ê¸°ë°˜ í˜ì´ì§• + ì •ë ¬ ì˜ˆì‹œì½”ë“œ

> ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´<br>
> ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ <br>
> í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

```java
// í˜ì´ì§• + ì •ë ¬
public List<Member> findByPage(int age, int offset, int limit) {
        return em.createQuery("select m from Member m where m.age = :age order by
    m.username desc")
                .setParameter("age", age)
       
 }
.setFirstResult(offset)
.setMaxResults(limit)
.getResultList();

// ì¹´ìš´íŠ¸
public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age",
Long.class)
}
.setParameter("age", age)
.getSingleResult();
```

* test ì½”ë“œ

```java
@Test
  public void paging() throws Exception {
//given
      memberJpaRepository.save(new Member("member1", 10));
      memberJpaRepository.save(new Member("member2", 10));
      memberJpaRepository.save(new Member("member3", 10));
      memberJpaRepository.save(new Member("member4", 10));
      memberJpaRepository.save(new Member("member5", 10));
      int age = 10;
      int offset = 0;
      int limit = 3;
//when
      List<Member> members = memberJpaRepository.findByPage(age, offset, limit);
      long totalCount = memberJpaRepository.totalCount(age);
//í˜ì´ì§€ ê³„ì‚° ê³µì‹ ì ìš©...
// totalPage = totalCount / size ...
// ë§ˆì§€ë§‰ í˜ì´ì§€ ... // ìµœì´ˆ í˜ì´ì§€ ..
//then
      assertThat(members.size()).isEqualTo(3);
 
       assertThat(totalCount).isEqualTo(5);
}
```

<br>
<br>

#### ğŸ‹ ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬

* í˜ì´ì§• ì •ë ¬ íŒŒë¼ë¯¸í„°
    - org.springframework.data.domain.Sort : ì •ë ¬ ê¸°ëŠ¥
    - org.springframework.data.domain.Pageable : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— Sort í¬í•¨)

* íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…
    - org.springframework.data.domain.Page : ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
        - contents ì¿¼ë¦¬ì™€ totalCount ì¿¼ë¦¬ê°€ í•¨ê»˜ ë‚˜ê°.
    - org.springframework.data.domain.Slice : ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ (ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)
        - í˜ì´ì§€ê°€ ì •í™•íˆ ë‚˜íƒ€ë‚˜ì§€ ì•Šê³ , ë”ë³´ê¸° ê¸°ëŠ¥ìœ¼ë¡œ ì¶”ê°€ ë°ì´í„°ë¥¼ ë³´ê²Œí•˜ëŠ” í˜•ì‹ì—ì„œ ì‚¬ìš©.
        - ìµœê·¼ ëª¨ë°”ì¼ í˜ì´ì§•(ë”ë³´ê¸°)ë¥¼ ìƒê°í•´ë³´ê¸°.
    - List (ìë°” ì»¬ë ‰ì…˜): ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

```java
// Pageable ì— pageí•  ì¡°ê±´ì„ ì‚½ì….
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ í•¨ê»˜ ì‚¬ìš© 

Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨

List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨

List<Member> findByUsername(String name, Sort sort);
```

#### ğŸ¯ page ì‚¬ìš©ì‹œ

* ì‚¬ìš©ì˜ˆì‹œ ì½”ë“œ
    - ìŠ¤í”„ë§ ë°ì´í„° ë ˆí¬ì§€í† ë¦¬
    ```java
    public interface MemberRepository extends Repository<Member, Long> {
            
        Page<Member> findByAge(int age, Pageable pageable);
    }
    ```

    - test ì½”ë“œ
    ```java
    /í˜ì´ì§• ì¡°ê±´ê³¼ ì •ë ¬ ì¡°ê±´ ì„¤ì •
    @Test
    public void page() throws Exception {
    //given
        memberRepository.save(new Member("member1", 10));
        memberRepository.save(new Member("member2", 10));
        memberRepository.save(new Member("member3", 10));
        memberRepository.save(new Member("member4", 10));
        memberRepository.save(new Member("member5", 10));
    
    //when
        PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC,
    "username"));   // page ì¡°ê±´ ì„¤ì •
        Page<Member> page = memberRepository.findByAge(10, pageRequest);
    
    //then
    List<Member> content = page.getContent(); //ì¡°íšŒëœ ë°ì´í„° 
    assertThat(content.size()).isEqualTo(3); //ì¡°íšŒëœ ë°ì´í„° ìˆ˜ - í˜ì´ì§€ ë‹¹ ê°¯ìˆ˜.
    assertThat(page.getTotalElements()).isEqualTo(5); //ì „ì²´ ë°ì´í„° ìˆ˜ - totalCountì¿¼ë¦¬ë„ ë™ì‹œì— ë‚˜ê°€ê¸° ë•Œë¬¸ì— ë°”ë¡œ ë½‘ì•„ë‚¼ ìˆ˜ ìˆìŒ.
    assertThat(page.getNumber()).isEqualTo(0); //í˜ì´ì§€ ë²ˆí˜¸ 
    assertThat(page.getTotalPages()).isEqualTo(2); //ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸ 
    assertThat(page.isFirst()).isTrue(); //ì²«ë²ˆì§¸ í•­ëª©ì¸ê°€? 
    assertThat(page.hasNext()).isTrue(); //ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?
    }
    ```

* ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ Pageable ì€ ì¸í„°í˜ì´ìŠ¤
    - ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ org.springframework.data.domain.PageRequest ê°ì²´ë¥¼ ì‚¬ìš©.

* PageëŠ” 1ë¶€í„° ì‹œì‘ì´ ì•„ë‹ˆë¼ 0ë¶€í„° ì‹œì‘ì´ë‹¤.

<br>


#### ğŸ¯ Slice ì‚¬ìš©ì‹œ pageì™€ì˜ ì°¨ì´ì 

* ìœ„ì˜ page ì˜ˆì‹œ ì½”ë“œì—ì„œ í•œ í˜ì´ì§•ë‹¹ limitë¥¼ 3ìœ¼ë¡œ ë‚ ë¦¬ë©´, Sliceì—ì„œëŠ” 1ë¥¼ ë”í•œ 4ë¥¼ ìš”ì²­í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼.

* totalCount ì¿¼ë¦¬ë¥¼ í•¨ê»˜ ë‚ ë¦¬ì§€ ì•Šìœ¼ë¯€ë¡œ, ì•„ë˜ ë‘ì¿¼ë¦¬ëŠ” ë¶ˆê°€. -> ë‚˜ë¨¸ì§€ ì¿¼ë¦¬ëŠ” ëª¨ë‘ ë™ì¼í•˜ê²Œ ì‚¬ìš©ê°€ëŠ¥.

```java
assertThat(page.getTotalElements()).isEqualTo(5);
assertThat(page.getTotalPages()).isEqualTo(2);
```

<br>


#### ğŸ¯ List ë¥¼ ì‚¬ìš©ì‹œ

* page ê¸°ëŠ¥ìœ¼ë¡œ ì‚¬ìš©í–ˆë˜ ì¿¼ë¦¬ë“¤ì˜ ëª¨ë“  í•¨ìˆ˜ ì‚¬ìš©ë¶ˆê°€. 
    - ìˆœìˆ˜í•œ í˜ì´ì§• ê¸°ëŠ¥ë§Œ êµ¬í˜„.

<br>

#### ğŸ¯ count ì¿¼ë¦¬ì˜ ë¶„ë¦¬

* ì‹¤ì œë¡œ ì¿¼ë¦¬ ì¡°ê±´ì´ ë§ì•„ì§€ê±°ë‚˜ joinì´ ë§ì•„ì§ˆë•Œ ë¶€í•˜ê°€ ìƒê¸°ëŠ” ê³³ì€ ê²°êµ­ totalcount ì¿¼ë¦¬ì´ë‹¤.(í˜ì´ì§•ì€ ì˜¤íˆë ¤ ìµœì í™”í•˜ê¸° ì‰½ë‹¤.)
    - ì „ì²´ countì¿¼ë¦¬ëŠ” ë§¤ìš° ë¬´ê±°ìš´ ì‘ì—…ì´ë‹¤.

* countì¿¼ë¦¬ë§Œ ë¶„ë¦¬í•´ì„œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ ìˆìŒ.
    - countì¿¼ë¦¬ê°€ ë”°ë¡œ ë‚˜ê°€ê²Œë¨.

    ```java
    @Query(value = â€œselect m from Member mâ€,
            countQuery = â€œselect count(m.username) from Member mâ€)
    Page<Member> findMemberAllCountBy(Pageable pageable);
    // ì‹¤ì œë¡œ left outer joinì—ì„œ ë‹¨ìˆœíˆ ì „ì²´ ë°ì´í„° ê°¯ìˆ˜ë¥¼ ë°˜í™˜í•˜ê¸° ìœ„í•´ joiní•  í•„ìš”ëŠ” ì—†ë‹¤.
    ```


<br>

#### ğŸ¯ í˜ì´ì§€ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜í•˜ê¸°

* ì—”í‹°í‹°ëŠ” ì ˆëŒ€ ë°–ìœ¼ë¡œ ë…¸ì¶œì‹œì¼œì„œëŠ” ì•ˆëœë‹¤!! 

* member ì—”í‹°í‹° -> memberDto ë³€í™˜ -> apië¡œ ë°˜í™˜ ê°€ëŠ¥!!

    ```java
    Page<Member> page = memberRepository.findByAge(10, pageRequest);

    Page<MemberDto> dtoPage = page.map(member -> new MemberDto(member.getId(), member.getUsername(), member.getTeam().getName()));
    // DTOì—ì„œ ì •ì˜í•œ ìƒì„±ìì— ë§ê²Œ mapìœ¼ë¡œ ë§ì¶°ì„œ ë°˜í™˜.
    ```

<br>
<br>
<br>
<br>


### ğŸ³ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

* "ëª¨ë“  ì§ì›ì˜ ì—°ë´‰ì„ 10% ì¸ìƒ ì‹œì¼œë¼!!!" -> ë²Œí¬ì„± ìˆ˜ì •ì˜ ì˜ë¯¸!

* ê¸°ì¡´ì˜ SQLë¬¸ìœ¼ë¡œ ì‘ì„±í•  ë•ŒëŠ” ì‰½ê²Œ ê°€ëŠ¥í•˜ì§€ë§Œ, ì—”í‹°í‹° ê¸°ë°˜ì˜ JPAì—ì„œëŠ” ìˆ˜ì •ì´ ë”í‹°ì²´í‚¹ì— ì˜í•´ êµ¬í˜„ë˜ë¯€ë¡œ, ë”°ë¡œ êµ¬í˜„í•˜ê¸°ê°€ ì–´ë ¤ì›Œì„œ ì´ëŸ° ê¸°ëŠ¥ì´ ë¶„ë¦¬ë˜ì–´ ì¡´ì¬í•œë‹¤!

* ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” @Modifying ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©.
    - ì‚¬ìš© ì•ˆí•˜ë©´, " org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations" ì˜ˆì™¸ ë°œìƒ.

* ğŸ€ ì£¼ì˜í•  ì !!!!
    - ë²Œí¬ì„± ì¿¼ë¦¬ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³ , ì§ì ‘ ë°”ë¡œ DBì— ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ê²Œ ëœë‹¤.
    - ë”°ë¼ì„œ, DBì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê°±ì‹  ìƒí™©ì´ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤!!!ğŸ”¥
    - ğŸ€ ì´ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´, ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ë‚ ë¦° ì´í›„ì— ê¼­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•´ì¤˜ì•¼ í•˜ëŠ” ê³¼ì •ì´ í•„ìˆ˜ì´ë‹¤!!
        - í•´ê²°ë°©ë²•1 : ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”: @Modifying(clearAutomatically = true) (ì´ ì˜µì…˜ì˜ ê¸°ë³¸ê°’ì€ false )
        - í•´ê²°ë°©ë²•2 : EntityManagerë¥¼ ì£¼ì…ë°›ì•„ì„œ, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•˜ì.(em.flush() + em.clear())

* ê¹€ì˜í•œë‹˜ì˜ ê¶Œì¥ ë°©ì•ˆ
    - 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
    - 2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤.

<br>

#### ğŸ¯ ìˆœìˆ˜ JPA

```java
public int bulkAgePlus(int age) {
        int resultCount = em.createQuery(
                "update Member m set m.age = m.age + 1" +
                        "where m.age >= :age")
                .setParameter("age", age)
                .executeUpdate();
        return resultCount;
   }
```

<br>

#### ğŸ¯ ìŠ¤í”„ë§ ë°ì´í„° JPA 

* ë³€ê²½í•œ ë°ì´í„°ì˜ ìˆ˜ë¥¼ ë°˜í™˜.

```java
@Modifying
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

```java
@Test
  public void bulkUpdate() throws Exception {
    //given
    memberRepository.save(new Member("member1", 10));
    memberRepository.save(new Member("member2", 19));
    memberRepository.save(new Member("member3", 20));
    memberRepository.save(new Member("member4", 21));
   
    memberRepository.save(new Member("member5", 40));
    
    //when
    int resultCount = memberRepository.bulkAgePlus(20);
    
    /*   ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•˜ëŠ” ë°©ë²• ì‚¬ìš©í•  ì‹œ.
    em.flush();
    em.clear();
    */
    
    //then
    assertThat(resultCount).isEqualTo(3);
    }
```


<br>
<br>
<br>


### ğŸ³ EntityGraph

<br>

#### ğŸš€ í˜ì¹˜ì¡°ì¸ì— ëŒ€í•œ ì •í™•í•œ ì´í•´ê°€ ê¸°ë³¸ì´ ë˜ì–´ì•¼ í•œë‹¤!!! ğŸš€

* í˜ì¹˜ ì¡°ì¸ì´ë€? -> ê°„ë‹¨ ìš”ì•½
    - ì „ë¶€ë‹¤ LAZYë¡œ ì„¸íŒ…. (ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ëŠ” í”„ë¡ì‹œë¡œë§Œ ë§Œë“¤ì–´ ë†ˆ..nullë¡œ ë†”ë‘˜ìˆœ ì—†ìë‚˜...)
    - ì—°ê´€ê´€ê³„(member ì™€ team ê´€ê³„ì²˜ëŸ¼) ë§¤í•‘ëœ í…Œì´ë¸”ì´ í•„ìš”í•  ë•Œë§ˆë‹¤ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ê²Œë¨
    - N+1 ë¬¸ì œê°€ ë°œìƒ.(ì¶”ê°€ ì¿¼ë¦¬ê°€ ê²ë‚˜ê²Œ ë°œìƒ.)
    - í˜ì¹˜ ì¡°ì¸ì„ ì´ìš©í•˜ì—¬, ì—°ê´€ê´€ê³„ì˜ ì—”í‹°í‹°ë¥¼ ë‹¨ í•œë²ˆì˜ SQLë¡œ í•œë²ˆì— ëŒê³ ì™€ì„œ ìµœì í™” ì‹œí‚´.(ì—°ê´€ê´€ê³„ ì—”í‹°í‹°ë„ í”„ë¡ì‹œê°€ ì•„ë‹Œ ì‹¤ì œë¡œ ë‹¤ ì±„ì›Œì§.)

<br>
<br>

> ì—°ê´€ëœ ì—”í‹°í‹°ë“¤ì„ SQL í•œë²ˆì— ì¡°íšŒí•˜ëŠ” ë°©ë²•.

> í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë ¤ë©´, ìŠ¤í”„ë§ ë°ì´í„°ì—ì„œëŠ” JPQLë¥¼ ê¼­ ì‚¬ìš©í•´ì„œ, ì§ì ‘ ì¿¼ë¦¬ì— ëª…ì‹œí•´ì•¼ í•  ê²ƒê°™ì€ë°, ê·¸ëŸ´í•„ìš” ì—†ê²Œ êµ¬í˜„í•œ ê¸°ëŠ¥.

> ì‚¬ì‹¤ìƒ í˜ì¹˜ ì¡°ì¸ì˜ ê°„í¸ ë²„ì ¼.

<br>

* ì‚¬ìš© ë°©ë²•ê³¼ ì˜ˆì‹œ ì½”ë“œ
    - ì‚¬ìš©ë°©ë²• : EntityGraphì˜ ì†ì„±ìœ¼ë¡œ ê°™ì´ ëŒê±°ì˜¬ ì—”í‹°í‹°ë¥¼ ëª…ì‹œ.

```java
//ê³µí†µ ë©”ì„œë“œ ì˜¤ë²„ë¼ì´ë“œ
@Override
@EntityGraph(attributePaths = {"team"}) 
List<Member> findAll();

//JPQL + ì—”í‹°í‹° ê·¸ë˜í”„ 
@EntityGraph(attributePaths = {"team"}) 
@Query("select m from Member m") List<Member> findMemberEntityGraph();

//ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ì—ì„œ íŠ¹íˆ í¸ë¦¬í•˜ë‹¤.
@EntityGraph(attributePaths = {"team"}) 
List<Member> findByUsername(String username)
```

<br>
<br>
<br>



### ğŸ³JPA Hint & Lock

<br>

#### ğŸ¯JPA Hint

<br>

> JPA ì¿¼ë¦¬ íŒíŠ¸(SQL íŒíŠ¸ê°€ ì•„ë‹ˆë¼ JPA êµ¬í˜„ì²´ì—ê²Œ ì œê³µí•˜ëŠ” íŒíŠ¸)

> JPA ì¿¼ë¦¬ì— ëŒ€í•´ ë””í´íŠ¸ì¸ ê¸°ëŠ¥ë“¤ì„ ì¬ì„¤ì • í•´ì£¼ëŠ” ëŠë‚Œ.

> ğŸ€ ê¸°ì¡´ì˜ JPAì—ì„œ ëª¨ë“  ì¡°íšŒ ì¿¼ë¦¬ì— ì˜í•´ ê°€ì ¸ì™€ì§„ ë°ì´í„°ì— ëŒ€í•œ ìŠ¤ëƒ…ìƒ·ì´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì–´ ìˆë‹¤. (ìŠ¤ëƒ…ìƒ·, ì¦‰ ê¸°ì¡´ì˜ ê°’ì´ ì„ì‹œë¡œ ì €ì¥ë˜ì–´ ìˆì–´ì•¼, ë³€ê²½ê°ì§€(ë”í‹°ì²´í‚¹)ë¥¼ ìë™ìœ¼ë¡œ ì‹œí–‰í•  ìˆ˜ ìˆìŒ)ê·¸ ë˜í•œ ì¼ì¢…ì˜ ë©”ëª¨ë¦¬ë¥¼ ë¨¹ëŠ” ì‘ì—…ì´ë¯€ë¡œ, ì½ê¸°ì „ìš©ì´ í™•ì‹¤í•œ ì¡°íšŒ ë°ì´í„°ì— í•œì—ì„œ, ìŠ¤ëƒ…ìƒ·ì„ ì €ì¥í•˜ì§€ ë§ë¼ê³ , JPA êµ¬í˜„ì²´ì—ê²Œ ì•Œë ¤ì£¼ê³ , ë©”ëª¨ë¦¬ ë¶€í•˜ë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤.(í•˜ì§€ë§Œ, ë“œë¼ë§ˆí‹±í•œ íš¨ê³¼ë¥¼ ë³´ì¥í•˜ê¸´ ì–´ë ¤ì›€)

* ì˜ˆì œ ì½”ë“œ
    - ë ˆí¬ì§€í† ë¦¬ - ì¿¼ë¦¬ íŒíŠ¸ ì‚¬ìš©
    ```java
    @QueryHints(value = @QueryHint(name = "org.hibernate.readOnly", value =
    "true"))
    // ì½ê¸° ì „ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê² ë‹¤ -> ìŠ¤ëƒ…ìƒ· ì €ì¥ âŒ
    Member findReadOnlyByUsername(String username);
    ```

    - test ì½”ë“œ
    ```java
    @Test
    public void queryHint() throws Exception {
    //given
        memberRepository.save(new Member("member1", 10));
        em.flush();
        em.clear();
    
    //when
        Member member = memberRepository.findReadOnlyByUsername("member1");
        member.setUsername("member2");
    
    em.flush(); //Update Query ì‹¤í–‰X }
    ```
    
* org.springframework.data.jpa.repository.QueryHints ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©


<br>
<br>

#### ğŸ¯Lock

* org.springframework.data.jpa.repository.Lock ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©.

* JPA ì±…ì„ ì°¸ê³ í•˜ì.

* ì˜ˆì œì½”ë“œ

```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
List<Member> findByUsername(String name);
```


<br>
<br>
<br>

















