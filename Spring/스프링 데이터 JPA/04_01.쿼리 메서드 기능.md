# ì¿¼ë¦¬ ë©”ì„œë“œ ê¸°ëŠ¥


<br>
<br>
<br>

## ğŸŒˆ ì¿¼ë¦¬ ë©”ì„œë“œ ê¸°ëŠ¥ 3ê°€ì§€

* ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±. ğŸ€

* ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ JPA NamedQuery í˜¸ì¶œ(ìì£¼ ì‚¬ìš©âŒ).

* @Query ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•´ì„œ ë ˆí¼ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ì— ì¿¼ë¦¬ ì§ì ‘ ì •ì˜. ğŸ€


<br>
<br>

## ğŸŒˆ 1. ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„±


<br>
<br>

> ë©”ì„œë“œ ì´ë¦„ì„ ë¶„ì„í•´ì„œ JPQL ì¿¼ë¦¬ ì‹¤í–‰.

* ì˜ˆì‹œ
    ```java
    List<Member> findByUsernameAndAgeGreaterThan(String username, int age);
    // Username ê¸°ë°˜ìœ¼ë¡œ ì¼ì¹˜ + Ageê°€ ageë³´ë‹¤ í° row ì¡°íšŒ
    ```


* ì¿¼ë¦¬ ë©”ì†Œë“œ í•„í„° ì¡°ê±´ 
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation)

* ì¡°íšŒ : find...By, read...By, query...By, get...By
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation)
    - By ëŠ” ë’¤ì— ì¡°ê±´ì´ ë” ë¶™ëŠ” ë‹¤ëŠ” ì˜ë¯¸ë¡œ, Byë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤ë©´ ì „ì²´ ì¡°íšŒí•œë‹¤.
    - ... ë¶€ë¶„ì€ ì•„ë¬´ ì´ë¦„ì´ë‚˜ ë„£ì–´ë„ í•´ë‹¹ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œë‹¤.

* COUNT : count...By /  ë°˜í™˜íƒ€ì… : long
* EXISTS : exists...By / ë°˜í™˜íƒ€ì… : boolean
* ì‚­ì œ : delete...By, remove...By / ë°˜í™˜íƒ€ì… : long
* DISTINCT : findDistinct, findMemberDistinctBy
    ```java
    List<Person> findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);
    List<Person> findPeopleDistinctByLastnameOrFirstname(String lastname, String firstname);
    // DISTINCT ëŠ” í•´ë‹¹ column ì•,ë’¤ ë¬´ê´€.
    ```
* LIMIT : findFirst3, findFirst, findTop, findTop3
    - [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result)


> ì°¸ê³  : ì´ ê¸°ëŠ¥ì€ ì—”í‹°í‹°ì˜ í•„ë“œëª…ì´ ë³€ê²½ë˜ë©°ë„ˆ ì¸í„°í˜ì´ìŠ¤ì— ì •ì˜í•œ ë©”ì„œë“œ ì´ë¦„ë„ ê¼­ í•¨ê»˜ ë³€ê²½í•´ì•¼í•¨. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹œì‘í•˜ëŠ” ì‹œì ì— ì˜¤ë¥˜ ë°œìƒ.<br>
ì´ë ‡ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì‹œì ì— ì˜¤ë¥˜ë¥¼ ì¸ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì´ ìŠ¤í”„ë§ ë°ì´í„° JPAì˜ ë§¤ìš° í° ì¥ì . ğŸ€

> ì´ë¦„ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì˜¤íˆë ¤ ë³µì¡í•´ì§ˆìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì¿¼ë¦¬ì˜ ì¡°ê±´ì´ ë§ì•„ì§ˆ ê²½ìš°ì—ëŠ” 3ë²ˆ ê¸°ëŠ¥ì¸ JPQLë¥¼ ì§ì ‘ ì§œëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ì.

<br>
<br>
<br>
<hr>
<br>
<br>

## ğŸŒˆ 3. @Query, ë¦¬í¬ì§€í† ë¦¬ ë©”ì†Œë“œì— ì¿¼ë¦¬ ì •ì˜í•˜ê¸°

<br>
<br>

> ì‹¤ë¬´ì—ì„œëŠ” ë©”ì„œë“œ ì´ë¦„ìœ¼ë¡œ ì¿¼ë¦¬ ìƒì„± ê¸°ëŠ¥ì€ íŒŒë¼ë¯¸í„°ê°€ ì¦ê°€í•˜ë©´ ë©”ì„œë“œ ì´ë¦„ì´ ë§¤ìš° ì§€ì €ë¶„í•´ì§„ë‹¤. ë”°ë¼ì„œ @Query ê¸°ëŠ¥ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œë¨.

* @org.springframework.data.jpa.repository.Query ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©.

* ì‹¤í–‰í•  ë©”ì„œë“œì— ì •ì  ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ë¯€ë¡œ <mark>ì´ë¦„ ì—†ëŠ” Named ì¿¼ë¦¬</mark>ë¼ í•  ìˆ˜ ìˆìŒ

* JPA Named ì¿¼ë¦¬ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆìŒ(ë§¤ìš° í° ì¥ì !)ğŸ€

```java
@Query("select m from Member m where m.username = :username and m.age = :age")
List<Member> findUser(@Param("username") String username, @Param("age") int
age);
```

<br>
<br>


### ğŸ³ @Query, ê°’, DTO ì¡°íšŒí•˜ê¸°

<br>

> ì—¬íƒœê¹Œì§€ëŠ” ëª¨ë‘ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ê°€ì ¸ì™”ëŠ”ë°, ë‹¨ìˆœíˆ ê°’ì´ë‚˜ DTOë¥¼ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•.

#### ğŸ¯ ê¸°ë³¸ ê°’ íƒ€ì…

<br>

```java
@Query("select m.username from Member m")
List<String> findUsernameList();
```

* ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹ì€ Member ê°™ì€ ì—”í‹°í‹° íƒ€ì…ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í–ˆì§€ë§Œ, ìœ„ì™€ ê°™ì´ String íƒ€ì…ì˜ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ìœ¼ë©´, usernameì˜ ì´ë¦„ ì „ë¶€ë¥¼ ë‹¨ìˆœíˆ ë¦¬ìŠ¤íŠ¸ë¡œ ë°›ì•„ì˜¬ ìˆ˜ ìˆë‹¤.

* JPA ê°’ íƒ€ì…(@Embedded)ë„ ì´ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒ ê°€ëŠ¥.

<br>
<br>

#### ğŸ¯ DTO íƒ€ì…

<br>

```java
// DTO ìƒì„±

@Data
  public class MemberDto {
      private Long id;
      private String username;
      private String teamName;

      public MemberDto(Long id, String username, String teamName) {
          this.id = id;
          this.username = username;
          this.teamName = teamName;
      }
}
```
```java
// Repository

@Query("select new study.datajpa.dto.MemberDto(m.id, m.username, t.name) " +
          "from Member m join m.team t")
List<MemberDto> findMemberDto();
```

* DTOë¡œ ì§ì ‘ ì¡°íšŒ í•˜ë ¤ë©´ new ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©.
    - new study.datajpa.dto.MemberDto(m.id, m.username, t.name) ëŠ” ì‹¤ì œë¡œ DTOí´ë˜ìŠ¤ì˜ ìƒì„±ìì— í•´ë‹¹í•œë‹¤. ë”°ë¼ì„œ ìƒì„±ìê°€ ì¡´ì¬í•´ì•¼í•¨.

<br>
<br>
<br>

### ğŸ³ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

<br>


* ìœ„ì¹˜ ê¸°ë°˜ -> ì‚¬ìš© âŒ
* ì´ë¦„ ê¸°ë°˜ 

```java
 select m from Member m where m.username = ?0 //ìœ„ì¹˜ ê¸°ë°˜ 
 select m from Member m where m.username = :name //ì´ë¦„ ê¸°ë°˜
````

> ì½”ë“œ ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ë¥¼ ìœ„í•´ <mark>ì´ë¦„ ê¸°ë°˜</mark>íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ì!!!

```java
@Query("select m from Member m where m.username = :name")
Member findMembers(@Param("name") String username);
```


#### ğŸ¯ ì»¬ë ‰ì…˜ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

* Collection íƒ€ì…ìœ¼ë¡œ in ì ˆ ì§€ì›.
    - inì ˆ ë’¤ì—ì˜¤ëŠ” ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ì´ë¦„ë“¤ì„ í¬í•¨í•˜ëŠ” ê²ƒì„ ì¡°íšŒ ê°€ëŠ¥.

```java
@Query("select m from Member m where m.username in :names")
List<Member> findByNames(@Param("names") List<String> names);
```


<br>
<br>
<br>

### ğŸ³ ë°˜í™˜ íƒ€ì…

<br>

> ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” ìœ ì—°í•œ ë°˜í™˜ íƒ€ì…ì„ ì§€ì›. [ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-return-types)

```java
List<Member> findByUsername(String name); //ì»¬ë ‰ì…˜ 
Member findByUsername(String name); //ë‹¨ê±´
Optional<Member> findByUsername(String name); //ë‹¨ê±´ Optional
```

* í•¨ìˆ˜ëª…ì— ë°˜í™˜íƒ€ì…ì„ ì ëŠ”ê²ƒì€ ì•ˆì ì–´ë„ ë˜ê³ , ë§¤ìš° ìœ ì—°í•˜ê²Œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì•„ë¬´ ëª…ì‚¬ë¡œ ì ì–´ë„ë¨.
    - ìœ„ì˜ í•¨ìˆ˜ëª…ë“¤ì„ ë‹¤ìŒê³¼ ê°™ì´ ë³€ê²½í•´ë„ ë¬´ê´€.
        - findListByUsername
        - findMemberByUsername
        - findOptionalByUsername


#### ğŸ¯ ì¡°íšŒ ê²°ê³¼ê°€ ë§ê±°ë‚˜ ì ì„ë•Œ!!

* ì»¬ë ‰ì…˜
    - ê²°ê³¼ ì—†ìŒ : ë¹ˆ ì»¬ë ‰ì…˜ ë°˜í™˜ -> ì „í˜€ ë¬¸ì œê°€ ë˜ì§€ ì•ŠìŒ.

* ë‹¨ê±´ ì¡°íšŒ
    - ê²°ê³¼ ì—†ìŒ : nullë°˜í™˜ -> ê²°ê³¼ê°€ ìˆê±°ë‚˜ ì—†ê±°ë‚˜ì˜ ë¬¸ì œë©´ Optional ë‹¨ê±´ì¡°íšŒë¥¼ ì‚¬ìš©í•˜ì.
    ```java
    Optional<Member> findMember = memberRepository.findOptionalByUsername("heesoo");
    // ìë°”8 ë¬¸ë²•ì„ ì ê·¹ í™œìš©í•˜ì.
    ```
    - ê²°ê³¼ê°€ 2ê±´ ì´ìƒ : javax.persistence.NonUniqueResultException ì˜ˆì™¸ ë°œìƒ

    
<br>
<br>
<br>


### ğŸ³ í˜ì´ì§•ê³¼ ì •ë ¬

<br>
<br>
<br>

#### ğŸ‹ ìˆœìˆ˜ JPA í˜ì´ì§•ê³¼ ì •ë ¬

<br>

* JPQL ê¸°ë°˜ í˜ì´ì§• + ì •ë ¬ ì˜ˆì‹œì½”ë“œ

> ê²€ìƒ‰ ì¡°ê±´: ë‚˜ì´ê°€ 10ì‚´<br>
> ì •ë ¬ ì¡°ê±´: ì´ë¦„ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ <br>
> í˜ì´ì§• ì¡°ê±´: ì²« ë²ˆì§¸ í˜ì´ì§€, í˜ì´ì§€ë‹¹ ë³´ì—¬ì¤„ ë°ì´í„°ëŠ” 3ê±´

```java
// í˜ì´ì§• + ì •ë ¬
public List<Member> findByPage(int age, int offset, int limit) {
        return em.createQuery("select m from Member m where m.age = :age order by
    m.username desc")
                .setParameter("age", age)
       
 }
.setFirstResult(offset)
.setMaxResults(limit)
.getResultList();

// ì¹´ìš´íŠ¸
public long totalCount(int age) {
    return em.createQuery("select count(m) from Member m where m.age = :age",
Long.class)
}
.setParameter("age", age)
.getSingleResult();
```

* test ì½”ë“œ

```java
@Test
  public void paging() throws Exception {
//given
      memberJpaRepository.save(new Member("member1", 10));
      memberJpaRepository.save(new Member("member2", 10));
      memberJpaRepository.save(new Member("member3", 10));
      memberJpaRepository.save(new Member("member4", 10));
      memberJpaRepository.save(new Member("member5", 10));
      int age = 10;
      int offset = 0;
      int limit = 3;
//when
      List<Member> members = memberJpaRepository.findByPage(age, offset, limit);
      long totalCount = memberJpaRepository.totalCount(age);
//í˜ì´ì§€ ê³„ì‚° ê³µì‹ ì ìš©...
// totalPage = totalCount / size ...
// ë§ˆì§€ë§‰ í˜ì´ì§€ ... // ìµœì´ˆ í˜ì´ì§€ ..
//then
      assertThat(members.size()).isEqualTo(3);
 
       assertThat(totalCount).isEqualTo(5);
}
```

<br>
<br>

#### ğŸ‹ ìŠ¤í”„ë§ ë°ì´í„° JPA í˜ì´ì§•ê³¼ ì •ë ¬

* í˜ì´ì§• ì •ë ¬ íŒŒë¼ë¯¸í„°
    - org.springframework.data.domain.Sort : ì •ë ¬ ê¸°ëŠ¥
    - org.springframework.data.domain.Pageable : í˜ì´ì§• ê¸°ëŠ¥ (ë‚´ë¶€ì— Sort í¬í•¨)

* íŠ¹ë³„í•œ ë°˜í™˜ íƒ€ì…
    - org.springframework.data.domain.Page : ì¶”ê°€ count ì¿¼ë¦¬ ê²°ê³¼ë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§•
        - contents ì¿¼ë¦¬ì™€ totalCount ì¿¼ë¦¬ê°€ í•¨ê»˜ ë‚˜ê°.
    - org.springframework.data.domain.Slice : ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ë‹¤ìŒ í˜ì´ì§€ë§Œ í™•ì¸ ê°€ëŠ¥ (ë‚´ë¶€ì ìœ¼ë¡œ limit + 1ì¡°íšŒ)
        - í˜ì´ì§€ê°€ ì •í™•íˆ ë‚˜íƒ€ë‚˜ì§€ ì•Šê³ , ë”ë³´ê¸° ê¸°ëŠ¥ìœ¼ë¡œ ì¶”ê°€ ë°ì´í„°ë¥¼ ë³´ê²Œí•˜ëŠ” í˜•ì‹ì—ì„œ ì‚¬ìš©.
    - List (ìë°” ì»¬ë ‰ì…˜): ì¶”ê°€ count ì¿¼ë¦¬ ì—†ì´ ê²°ê³¼ë§Œ ë°˜í™˜

```java
// Pageable ì— pageí•  ì¡°ê±´ì„ ì‚½ì….
Page<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ í•¨ê»˜ ì‚¬ìš© 

Slice<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨

List<Member> findByUsername(String name, Pageable pageable); //count ì¿¼ë¦¬ ì‚¬ìš© ì•ˆí•¨

List<Member> findByUsername(String name, Sort sort);
```

#### ğŸ¯ page ì‚¬ìš©ì‹œ

* ì‚¬ìš©ì˜ˆì‹œ ì½”ë“œ
    - ìŠ¤í”„ë§ ë°ì´í„° ë ˆí¬ì§€í† ë¦¬
    ```java
    public interface MemberRepository extends Repository<Member, Long> {
            
        Page<Member> findByAge(int age, Pageable pageable);
    }
    ```

    - test ì½”ë“œ
    ```java
    /í˜ì´ì§• ì¡°ê±´ê³¼ ì •ë ¬ ì¡°ê±´ ì„¤ì •
    @Test
    public void page() throws Exception {
    //given
        memberRepository.save(new Member("member1", 10));
        memberRepository.save(new Member("member2", 10));
        memberRepository.save(new Member("member3", 10));
        memberRepository.save(new Member("member4", 10));
        memberRepository.save(new Member("member5", 10));
    
    //when
        PageRequest pageRequest = PageRequest.of(0, 3, Sort.by(Sort.Direction.DESC,
    "username"));   // page ì¡°ê±´ ì„¤ì •
        Page<Member> page = memberRepository.findByAge(10, pageRequest);
    
    //then
    List<Member> content = page.getContent(); //ì¡°íšŒëœ ë°ì´í„° 
    assertThat(content.size()).isEqualTo(3); //ì¡°íšŒëœ ë°ì´í„° ìˆ˜ - í˜ì´ì§€ ë‹¹ ê°¯ìˆ˜.
    assertThat(page.getTotalElements()).isEqualTo(5); //ì „ì²´ ë°ì´í„° ìˆ˜ - totalCountì¿¼ë¦¬ë„ ë™ì‹œì— ë‚˜ê°€ê¸° ë•Œë¬¸ì— ë°”ë¡œ ë½‘ì•„ë‚¼ ìˆ˜ ìˆìŒ.
    assertThat(page.getNumber()).isEqualTo(0); //í˜ì´ì§€ ë²ˆí˜¸ 
    assertThat(page.getTotalPages()).isEqualTo(2); //ì „ì²´ í˜ì´ì§€ ë²ˆí˜¸ 
    assertThat(page.isFirst()).isTrue(); //ì²«ë²ˆì§¸ í•­ëª©ì¸ê°€? 
    assertThat(page.hasNext()).isTrue(); //ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ”ê°€?
    }
    ```

* ë‘ ë²ˆì§¸ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ Pageable ì€ ì¸í„°í˜ì´ìŠ¤
    - ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” í•´ë‹¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ org.springframework.data.domain.PageRequest ê°ì²´ë¥¼ ì‚¬ìš©.

* PageëŠ” 1ë¶€í„° ì‹œì‘ì´ ì•„ë‹ˆë¼ 0ë¶€í„° ì‹œì‘ì´ë‹¤.


#### ğŸ¯ Slice ì‚¬ìš©ì‹œ pageì™€ì˜ ì°¨ì´ì 

* ìœ„ì˜ page ì˜ˆì‹œ ì½”ë“œì—ì„œ í•œ í˜ì´ì§•ë‹¹ limitë¥¼ 3ìœ¼ë¡œ ë‚ ë¦¬ë©´, Sliceì—ì„œëŠ” 1ë¥¼ ë”í•œ 4ë¥¼ ìš”ì²­í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ë‚ ë¦¼.

* totalCount ì¿¼ë¦¬ë¥¼ í•¨ê»˜ ë‚ ë¦¬ì§€ ì•Šìœ¼ë¯€ë¡œ, ì•„ë˜ ë‘ì¿¼ë¦¬ëŠ” ë¶ˆê°€. -> ë‚˜ë¨¸ì§€ ì¿¼ë¦¬ëŠ” ëª¨ë‘ ë™ì¼í•˜ê²Œ ì‚¬ìš©ê°€ëŠ¥.

```java
assertThat(page.getTotalElements()).isEqualTo(5);
assertThat(page.getTotalPages()).isEqualTo(2);
```

#### ğŸ¯ List ë¥¼ ì‚¬ìš©ì‹œ

* page ê¸°ëŠ¥ìœ¼ë¡œ ì‚¬ìš©í–ˆë˜ ì¿¼ë¦¬ë“¤ì˜ ëª¨ë“  í•¨ìˆ˜ ì‚¬ìš©ë¶ˆê°€. 
    - ìˆœìˆ˜í•œ í˜ì´ì§• ê¸°ëŠ¥ë§Œ êµ¬í˜„.


#### ğŸ¯ ê³ ë ¤í•  ì‚¬í•­.















